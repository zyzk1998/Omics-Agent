services:
  # =========================================
  # 1. æ¶ˆæ¯é˜Ÿåˆ— - Redis
  # =========================================
  redis:
    image: redis:7-alpine
    container_name: gibh_v2_redis
    restart: always
    volumes:
      - ./data/redis:/data
    networks:
      - gibh-network
    command: redis-server --appendonly yes

  # =========================================
  # 2. API æœåŠ¡å™¨ - FastAPI + Gunicornï¼ˆç›´æŽ¥æš´éœ²ç«¯å£ï¼‰
  # =========================================
  api-server:
    build:
      context: .
      dockerfile: services/api/Dockerfile
    image: gibh-v2-api:latest
    container_name: gibh_v2_api
    restart: always
    ports:
      - "8028:8028"  # ç›´æŽ¥æš´éœ² API æœåŠ¡å™¨ç«¯å£
    environment:
      - TZ=Asia/Shanghai
      - REDIS_URL=redis://redis:6379/0
      - UPLOAD_DIR=/app/uploads
      - RESULTS_DIR=/app/results
      - PYTHONPATH=/app
      # ðŸ”’ å®‰å…¨ï¼šä»ŽçŽ¯å¢ƒå˜é‡è¯»å– API å¯†é’¥ï¼Œä¸è¦ç¡¬ç¼–ç 
      - SILICONFLOW_API_KEY=${SILICONFLOW_API_KEY}
      - SILICONFLOW_MODEL=${SILICONFLOW_MODEL:-deepseek-ai/DeepSeek-R1}
      # ðŸ”’ å®‰å…¨ï¼šæ–‡ä»¶ä¸Šä¼ é™åˆ¶
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-104857600}
      # ðŸ”’ å®‰å…¨ï¼šCORS é…ç½®
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}
      # ä¿®å¤ Numba å’Œ Matplotlib æƒé™é—®é¢˜
      - NUMBA_CACHE_DIR=/home/appuser/.cache/numba
      - MPLCONFIGDIR=/home/appuser/.config/matplotlib
      - HOME=/home/appuser
      # ç¦ç”¨ Numba ç¼“å­˜è°ƒè¯•ï¼ˆå¸®åŠ©è§£å†³ç¼“å­˜é—®é¢˜ï¼‰
      - NUMBA_DEBUG_CACHE=1
    volumes:
      - .:/app
      - ./data/uploads:/app/uploads
      - ./results:/app/results
      - ./data:/app/data
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      - redis
    networks:
      - gibh-network
    # ðŸ”§ ä¿®å¤ï¼šä½¿ç”¨ entrypoint è„šæœ¬ä¿®å¤æƒé™
    entrypoint: ["/entrypoint.sh"]
    command: gunicorn server:app -w 2 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8028 --timeout 300

  # =========================================
  # 3. å¼‚æ­¥ä»»åŠ¡å¤„ç† - Celery Workerï¼ˆå¯é€‰ï¼‰
  # =========================================
  worker:
    build:
      context: .
      dockerfile: services/api/Dockerfile
    image: gibh-v2-api:latest
    container_name: gibh_v2_worker
    restart: always
    environment:
      - TZ=Asia/Shanghai
      - REDIS_URL=redis://redis:6379/0
      - UPLOAD_DIR=/app/uploads
      - RESULTS_DIR=/app/results
      - PYTHONPATH=/app
      # ðŸ”’ å®‰å…¨ï¼šä»ŽçŽ¯å¢ƒå˜é‡è¯»å– API å¯†é’¥
      - SILICONFLOW_API_KEY=${SILICONFLOW_API_KEY}
      - SILICONFLOW_MODEL=${SILICONFLOW_MODEL:-deepseek-ai/DeepSeek-R1}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-104857600}
      # ä¿®å¤ Numba å’Œ Matplotlib æƒé™é—®é¢˜
      - NUMBA_CACHE_DIR=/home/appuser/.cache/numba
      - MPLCONFIGDIR=/home/appuser/.config/matplotlib
      - HOME=/home/appuser
      # ç¦ç”¨ Numba ç¼“å­˜è°ƒè¯•ï¼ˆå¸®åŠ©è§£å†³ç¼“å­˜é—®é¢˜ï¼‰
      - NUMBA_DEBUG_CACHE=1
    volumes:
      - .:/app
      - ./data/uploads:/app/uploads
      - ./results:/app/results
      - ./data:/app/data
      - /etc/localtime:/etc/localtime:ro
    # ðŸ”§ ä¿®å¤ï¼šåœ¨å®¹å™¨å¯åŠ¨æ—¶ä¿®å¤æŒ‚è½½ç›®å½•çš„æƒé™
    entrypoint: |
      sh -c "
        # ä¿®å¤æŒ‚è½½ç›®å½•çš„æƒé™ï¼ˆç¡®ä¿ appuser å¯ä»¥å†™å…¥ï¼‰
        chown -R appuser:appuser /app/uploads /app/results /app/data 2>/dev/null || true
        # æ‰§è¡ŒåŽŸå§‹å‘½ä»¤
        exec celery -A gibh_agent.core.celery_app worker --loglevel=info --concurrency=4
      "
    networks:
      - gibh-network
    command: celery -A gibh_agent.core.celery_app worker --loglevel=info --concurrency=4

networks:
  gibh-network:
    driver: bridge

volumes:
  redis-data:
    driver: local

