<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯æŒ‰é’®åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-header {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .test-result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 4px;
        }
        .test-result.pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-result.fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #card-zone {
            min-height: 200px;
            border: 2px dashed #ccc;
            padding: 15px;
            margin: 15px 0;
            background: #fafafa;
        }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #218838;
        }
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ§ª å‰ç«¯æŒ‰é’®åŠŸèƒ½æµ‹è¯•</h1>
            <p>éªŒè¯"æ‰§è¡Œå·¥ä½œæµ"æŒ‰é’®ä½¿ç”¨DOMéå†å¯ä»¥æ­£å¸¸å·¥ä½œ</p>
        </div>

        <div class="test-step">
            <h3>æµ‹è¯•åŒºåŸŸ</h3>
            <div id="card-zone"></div>
            <button onclick="runButtonTests()">ğŸš€ è¿è¡ŒæŒ‰é’®æµ‹è¯•</button>
            <button onclick="clearTests()" style="background: #dc3545;">ğŸ—‘ï¸ æ¸…é™¤æµ‹è¯•</button>
        </div>

        <div id="test-results"></div>
    </div>

    <script>
        // ğŸ”¥ TASK 1 FIX: ä½¿ç”¨DOMéå†çš„æ‰§è¡Œå‡½æ•°ï¼ˆä»index.htmlå¤åˆ¶ï¼‰
        function executeWorkflowFromForm(buttonElement) {
            // ğŸ”¥ TASK 1: Find form using DOM traversal (works 100% of the time)
            const formElement = buttonElement.closest('form');
            if (!formElement) {
                console.error("âŒ [executeWorkflowFromForm] æœªæ‰¾åˆ°è¡¨å•å…ƒç´ ï¼ˆé€šè¿‡DOMéå†ï¼‰");
                alert("é”™è¯¯ï¼šæœªæ‰¾åˆ°å·¥ä½œæµè¡¨å•");
                return false;
            }
            
            const formId = formElement.id;
            console.log("ğŸš€ [executeWorkflowFromForm] ä»è¡¨å•æ‰§è¡Œå·¥ä½œæµï¼ŒformId:", formId);
            console.log("âœ… [executeWorkflowFromForm] æˆåŠŸæ‰¾åˆ°è¡¨å•å…ƒç´ ï¼ˆä½¿ç”¨DOMéå†ï¼‰");
            return true;
        }

        // æ¨¡æ‹Ÿæ¸²æŸ“å·¥ä½œæµå¡ç‰‡
        function renderWorkflowCard(workflowData) {
            const cardZoneRef = document.getElementById('card-zone');
            if (!cardZoneRef) return null;
            
            const formId = `wf-card-${Date.now()}`;
            const workflowCardId = 'workflow-card-container';
            
            let formHtml = `<div class="alert alert-success" id="${workflowCardId}" data-form-id="${formId}">
                <h5>ğŸ“‹ ${workflowData.workflow_name || 'æµ‹è¯•å·¥ä½œæµ'}</h5>
                <form id="${formId}">
                    <p>å·¥ä½œæµåŒ…å« ${workflowData.steps?.length || 0} ä¸ªæ­¥éª¤</p>
                    <button type="button" class="btn btn-success btn-sm" id="execute-workflow-${formId}" 
                            onclick="executeWorkflowFromForm(this)">
                        ğŸš€ æ‰§è¡Œå·¥ä½œæµ
                    </button>
                </form>
            </div>`;
            
            cardZoneRef.insertAdjacentHTML('beforeend', formHtml);
            return formId;
        }

        function addTestResult(testName, passed, message, details = '') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result ' + (passed ? 'pass' : 'fail');
            resultDiv.innerHTML = `
                <h4>${testName}</h4>
                <p><strong>${passed ? 'âœ… PASS' : 'âŒ FAIL'}:</strong> ${message}</p>
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            resultsDiv.appendChild(resultDiv);
        }

        function clearTests() {
            document.getElementById('card-zone').innerHTML = '';
            document.getElementById('test-results').innerHTML = '';
        }

        function runButtonTests() {
            clearTests();
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<h2>æµ‹è¯•ç»“æœ</h2>';
            
            let allPassed = true;
            
            // æµ‹è¯• 1: æ­£å¸¸æ¸²æŸ“å’ŒæŒ‰é’®ç‚¹å‡»
            try {
                const workflowData = {
                    workflow_name: 'æµ‹è¯•å·¥ä½œæµ',
                    steps: [
                        { id: 'step1', name: 'æ­¥éª¤1' },
                        { id: 'step2', name: 'æ­¥éª¤2' }
                    ]
                };
                
                const formId = renderWorkflowCard(workflowData);
                const button = document.querySelector(`#execute-workflow-${formId}`);
                
                if (!button) {
                    addTestResult('æµ‹è¯• 1: æŒ‰é’®æ¸²æŸ“', false, 'æœªæ‰¾åˆ°æ‰§è¡ŒæŒ‰é’®');
                    allPassed = false;
                } else {
                    const result = executeWorkflowFromForm(button);
                    if (result) {
                        addTestResult('æµ‹è¯• 1: æŒ‰é’®æ¸²æŸ“å’Œç‚¹å‡»', true, 
                            `æˆåŠŸæ‰¾åˆ°è¡¨å•å¹¶æ‰§è¡Œï¼ŒformId: ${formId}`);
                    } else {
                        addTestResult('æµ‹è¯• 1: æŒ‰é’®æ¸²æŸ“å’Œç‚¹å‡»', false, 'æ‰§è¡Œå¤±è´¥');
                        allPassed = false;
                    }
                }
            } catch (e) {
                addTestResult('æµ‹è¯• 1: æŒ‰é’®æ¸²æŸ“å’Œç‚¹å‡»', false, `å¼‚å¸¸: ${e.message}`);
                allPassed = false;
            }
            
            // æµ‹è¯• 2: IDåŠ¨æ€å˜åŒ–åä»èƒ½å·¥ä½œ
            try {
                const form = document.querySelector('form');
                if (!form) {
                    addTestResult('æµ‹è¯• 2: IDåŠ¨æ€å˜åŒ–', false, 'æœªæ‰¾åˆ°è¡¨å•');
                    allPassed = false;
                } else {
                    const originalId = form.id;
                    form.id = 'changed-id-' + Date.now();
                    const button = form.querySelector('button[onclick*="executeWorkflowFromForm"]');
                    
                    if (button) {
                        const result = executeWorkflowFromForm(button);
                        form.id = originalId; // æ¢å¤
                        
                        if (result) {
                            addTestResult('æµ‹è¯• 2: IDåŠ¨æ€å˜åŒ–', true, 
                                'DOMéå†åœ¨IDå˜åŒ–åä»èƒ½æ­£å¸¸å·¥ä½œ');
                        } else {
                            addTestResult('æµ‹è¯• 2: IDåŠ¨æ€å˜åŒ–', false, 'DOMéå†å¤±è´¥');
                            allPassed = false;
                        }
                    } else {
                        addTestResult('æµ‹è¯• 2: IDåŠ¨æ€å˜åŒ–', false, 'æœªæ‰¾åˆ°æŒ‰é’®');
                        allPassed = false;
                    }
                }
            } catch (e) {
                addTestResult('æµ‹è¯• 2: IDåŠ¨æ€å˜åŒ–', false, `å¼‚å¸¸: ${e.message}`);
                allPassed = false;
            }
            
            // æµ‹è¯• 3: å¤šä¸ªè¡¨å•ï¼Œç¡®ä¿æ‰¾åˆ°æ­£ç¡®çš„è¡¨å•
            try {
                const workflowData2 = {
                    workflow_name: 'ç¬¬äºŒä¸ªå·¥ä½œæµ',
                    steps: [{ id: 'step1', name: 'æ­¥éª¤1' }]
                };
                const formId2 = renderWorkflowCard(workflowData2);
                const button2 = document.querySelector(`#execute-workflow-${formId2}`);
                
                if (button2) {
                    const result = executeWorkflowFromForm(button2);
                    const foundFormId = button2.closest('form').id;
                    
                    if (result && foundFormId === formId2) {
                        addTestResult('æµ‹è¯• 3: å¤šä¸ªè¡¨å•', true, 
                            `æˆåŠŸæ‰¾åˆ°æ­£ç¡®çš„è¡¨å•ï¼ŒformId: ${foundFormId}`);
                    } else {
                        addTestResult('æµ‹è¯• 3: å¤šä¸ªè¡¨å•', false, 
                            `è¡¨å•IDä¸åŒ¹é…: æœŸæœ› ${formId2}, å®é™… ${foundFormId}`);
                        allPassed = false;
                    }
                } else {
                    addTestResult('æµ‹è¯• 3: å¤šä¸ªè¡¨å•', false, 'æœªæ‰¾åˆ°ç¬¬äºŒä¸ªæŒ‰é’®');
                    allPassed = false;
                }
            } catch (e) {
                addTestResult('æµ‹è¯• 3: å¤šä¸ªè¡¨å•', false, `å¼‚å¸¸: ${e.message}`);
                allPassed = false;
            }
            
            // æ€»ç»“
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'test-result ' + (allPassed ? 'pass' : 'fail');
            summaryDiv.innerHTML = `
                <h3>ğŸ“Š æµ‹è¯•æ€»ç»“</h3>
                <p><strong>${allPassed ? 'âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡' : 'âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥'}</strong></p>
            `;
            resultsDiv.appendChild(summaryDiv);
        }
    </script>
</body>
</html>
