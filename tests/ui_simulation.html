<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UI Simulation Test - Workflow Card Rendering</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-header {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .test-step {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        .test-step h3 {
            margin-top: 0;
            color: #007bff;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .test-result.pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-result.fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        #card-zone {
            min-height: 200px;
            border: 2px dashed #ccc;
            padding: 15px;
            margin: 15px 0;
            background: #fafafa;
        }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #218838;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .params-form {
            margin: 10px 0;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ§ª UI Simulation Test - Workflow Card Rendering</h1>
            <p>æµ‹è¯•å·¥ä½œæµå¡ç‰‡æ¸²æŸ“é€»è¾‘å’ŒIDåŒæ­¥æœºåˆ¶</p>
        </div>

        <div class="test-step">
            <h3>æµ‹è¯•åŒºåŸŸ</h3>
            <div id="card-zone"></div>
            <button onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button onclick="clearTests()" class="danger">ğŸ—‘ï¸ æ¸…é™¤æµ‹è¯•</button>
        </div>

        <div id="test-results"></div>
    </div>

    <script>
        // ğŸ”¥ PHASE 3: Mock renderWorkflowCard function (copied from index.html with fixes)
        function renderWorkflowCard(workflowData) {
            console.log("ğŸ” [renderWorkflowCard] Rendering Interactive Workflow Card:", workflowData);
            
            const cardZoneRef = document.getElementById('card-zone');
            
            if (!cardZoneRef) {
                console.error("âŒ [renderWorkflowCard] cardZone ä¸å­˜åœ¨ï¼Œæ— æ³•æ¸²æŸ“");
                return null;
            }
            
            if (!workflowData) {
                console.error("âŒ [renderWorkflowCard] workflowData ä¸ºç©º");
                cardZoneRef.innerHTML += '<div class="alert alert-warning">âš ï¸ å·¥ä½œæµæ•°æ®ä¸ºç©º</div>';
                return null;
            }
            
            // ğŸ”¥ PHASE 1 FIX: Idempotency Check - Prevent double rendering, but return existing ID
            const workflowCardId = 'workflow-card-container';
            const existingWorkflowCard = cardZoneRef.querySelector(`#${workflowCardId}`);
            if (existingWorkflowCard) {
                const existingIsTemplate = existingWorkflowCard.innerHTML.includes("é¢„è§ˆæ¨¡å¼") || 
                                           existingWorkflowCard.innerHTML.includes("template_mode");
                const newIsTemplate = workflowData.template_mode !== false;
                
                if (existingIsTemplate === newIsTemplate) {
                    // ğŸ”¥ PHASE 1 FIX: Extract existing form ID and return it
                    const existingForm = existingWorkflowCard.querySelector('form');
                    const existingFormId = existingForm ? existingForm.id : null;
                    const existingDataFormId = existingWorkflowCard.getAttribute('data-form-id');
                    const existingId = existingFormId || existingDataFormId;
                    
                    if (existingId) {
                        console.log(`âœ… [renderWorkflowCard] é‡ç”¨ç°æœ‰å¡ç‰‡ï¼Œè¿”å›ç°æœ‰ID: ${existingId}`);
                        return existingId;  // Return existing ID so execute button knows what to target
                    } else {
                        console.warn("âš ï¸ [renderWorkflowCard] å·¥ä½œæµå¡ç‰‡å·²å­˜åœ¨ä½†æ— æ³•æå–IDï¼Œè·³è¿‡é‡å¤æ¸²æŸ“");
                        return null;
                    }
                } else {
                    console.log("âœ… [renderWorkflowCard] å…è®¸ä»é¢„è§ˆæ¨¡å¼å‡çº§åˆ°æ‰§è¡Œæ¨¡å¼ï¼Œç§»é™¤æ—§å¡ç‰‡");
                    existingWorkflowCard.remove();
                }
            }
            
            // Safety check - ignore empty steps
            const workflowSteps = workflowData.workflow_config?.workflow_data?.steps || 
                                 workflowData.workflow_config?.steps ||
                                 workflowData.workflow_data?.steps || 
                                 workflowData.steps || [];
            
            if (!workflowSteps || workflowSteps.length === 0) {
                console.warn("âš ï¸ [renderWorkflowCard] Received empty steps from backend. Ignoring.");
                return null;
            }
            
            const workflowName = workflowData.workflow_config?.workflow_data?.workflow_name ||
                              workflowData.workflow_data?.workflow_name ||
                              workflowData.workflow_name ||
                              'å·¥ä½œæµè®¡åˆ’';
            
            const isTemplateMode = workflowData.template_mode !== false;
            const formId = `wf-card-${Date.now()}`;
            
            let formHtml = `<div class="alert alert-success params-form" id="${workflowCardId}" data-form-id="${formId}" style="border-left: 4px solid #28a745;">
                <h5>ğŸ“‹ ${workflowName} ${isTemplateMode ? '<span class="badge bg-secondary">[æ¨¡ç‰ˆé¢„è§ˆ Mode]</span>' : ''}</h5>
                <form id="${formId}">
                    <p>å·¥ä½œæµåŒ…å« ${workflowSteps.length} ä¸ªæ­¥éª¤</p>
                    <button type="button" class="btn btn-success btn-sm" id="execute-workflow-${formId}" 
                            onclick="executeWorkflowFromForm('${formId}')">
                        ğŸš€ æ‰§è¡Œå·¥ä½œæµ
                    </button>
                </form>
            </div>`;
            
            cardZoneRef.insertAdjacentHTML('beforeend', formHtml);
            console.log(`âœ… [renderWorkflowCard] äº¤äº’å¼å·¥ä½œæµå¡ç‰‡å·²æ¸²æŸ“åˆ° cardZone, formId: ${formId}`);
            return formId;  // Return the newly generated formId
        }
        
        // Mock executeWorkflowFromForm function
        function executeWorkflowFromForm(formId) {
            console.log("ğŸš€ [executeWorkflowFromForm] ä»è¡¨å•æ‰§è¡Œå·¥ä½œæµï¼ŒformId:", formId);
            const formElement = document.getElementById(formId);
            if (!formElement) {
                console.error("âŒ [executeWorkflowFromForm] æœªæ‰¾åˆ°è¡¨å•å…ƒç´ :", formId);
                alert("é”™è¯¯ï¼šæœªæ‰¾åˆ°å·¥ä½œæµè¡¨å•");
                return false;
            }
            console.log("âœ… [executeWorkflowFromForm] æˆåŠŸæ‰¾åˆ°è¡¨å•å…ƒç´ ");
            return true;
        }
        
        // Test helper functions
        function addTestResult(stepNum, testName, passed, message, details = '') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-step';
            resultDiv.innerHTML = `
                <h3>Step ${stepNum}: ${testName}</h3>
                <div class="test-result ${passed ? 'pass' : 'fail'}">
                    ${passed ? 'âœ… PASS' : 'âŒ FAIL'}: ${message}
                </div>
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            resultsDiv.appendChild(resultDiv);
        }
        
        function clearTests() {
            document.getElementById('card-zone').innerHTML = '';
            document.getElementById('test-results').innerHTML = '';
        }
        
        function runAllTests() {
            clearTests();
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<h2>æµ‹è¯•ç»“æœ</h2>';
            
            // Test Step 1: Simulate receiving a workflow event (Draft Mode)
            addTestResult(1, 'æ¨¡æ‹Ÿæ¥æ”¶å·¥ä½œæµäº‹ä»¶ï¼ˆé¢„è§ˆæ¨¡å¼ï¼‰', false, 'å‡†å¤‡æµ‹è¯•...', '');
            const mockWorkflowData1 = {
                workflow_config: {
                    workflow_data: {
                        workflow_name: 'æµ‹è¯•å·¥ä½œæµ',
                        steps: [
                            { id: 'step1', name: 'æ­¥éª¤1', params: {} },
                            { id: 'step2', name: 'æ­¥éª¤2', params: {} }
                        ]
                    }
                },
                template_mode: true
            };
            
            const returnedFormId1 = renderWorkflowCard(mockWorkflowData1);
            const cardCount1 = document.querySelectorAll('#workflow-card-container').length;
            const formExists1 = document.getElementById(returnedFormId1) !== null;
            
            if (cardCount1 === 1 && formExists1 && returnedFormId1) {
                addTestResult(1, 'æ¨¡æ‹Ÿæ¥æ”¶å·¥ä½œæµäº‹ä»¶ï¼ˆé¢„è§ˆæ¨¡å¼ï¼‰', true, 
                    `å¡ç‰‡å·²æ¸²æŸ“ï¼ŒformId: ${returnedFormId1}`, 
                    `è¿”å›çš„formId: ${returnedFormId1}\nå¡ç‰‡æ•°é‡: ${cardCount1}`);
            } else {
                addTestResult(1, 'æ¨¡æ‹Ÿæ¥æ”¶å·¥ä½œæµäº‹ä»¶ï¼ˆé¢„è§ˆæ¨¡å¼ï¼‰', false, 
                    `å¡ç‰‡æ¸²æŸ“å¤±è´¥`, 
                    `è¿”å›çš„formId: ${returnedFormId1}\nå¡ç‰‡æ•°é‡: ${cardCount1}\nè¡¨å•å­˜åœ¨: ${formExists1}`);
                return;
            }
            
            // Test Step 2: Simulate receiving the SAME workflow event again (Duplicate)
            addTestResult(2, 'æ¨¡æ‹Ÿæ¥æ”¶ç›¸åŒçš„å·¥ä½œæµäº‹ä»¶ï¼ˆé‡å¤ï¼‰', false, 'å‡†å¤‡æµ‹è¯•...', '');
            const returnedFormId2 = renderWorkflowCard(mockWorkflowData1);
            const cardCount2 = document.querySelectorAll('#workflow-card-container').length;
            
            if (cardCount2 === 1 && returnedFormId2 === returnedFormId1) {
                addTestResult(2, 'æ¨¡æ‹Ÿæ¥æ”¶ç›¸åŒçš„å·¥ä½œæµäº‹ä»¶ï¼ˆé‡å¤ï¼‰', true, 
                    `å¹‚ç­‰æ€§æ£€æŸ¥é€šè¿‡ï¼šå¡ç‰‡æ•°é‡ä»ä¸º1ï¼Œè¿”å›ç›¸åŒçš„formId`, 
                    `ç¬¬ä¸€æ¬¡formId: ${returnedFormId1}\nç¬¬äºŒæ¬¡formId: ${returnedFormId2}\nå¡ç‰‡æ•°é‡: ${cardCount2}`);
            } else {
                addTestResult(2, 'æ¨¡æ‹Ÿæ¥æ”¶ç›¸åŒçš„å·¥ä½œæµäº‹ä»¶ï¼ˆé‡å¤ï¼‰', false, 
                    `å¹‚ç­‰æ€§æ£€æŸ¥å¤±è´¥ï¼šå¡ç‰‡è¢«é‡å¤æ¸²æŸ“æˆ–IDä¸åŒ¹é…`, 
                    `ç¬¬ä¸€æ¬¡formId: ${returnedFormId1}\nç¬¬äºŒæ¬¡formId: ${returnedFormId2}\nå¡ç‰‡æ•°é‡: ${cardCount2}`);
                return;
            }
            
            // Test Step 3: Simulate clicking "Execute"
            addTestResult(3, 'æ¨¡æ‹Ÿç‚¹å‡»æ‰§è¡ŒæŒ‰é’®', false, 'å‡†å¤‡æµ‹è¯•...', '');
            const executeResult = executeWorkflowFromForm(returnedFormId2);
            const formElement = document.getElementById(returnedFormId2);
            
            if (executeResult && formElement) {
                addTestResult(3, 'æ¨¡æ‹Ÿç‚¹å‡»æ‰§è¡ŒæŒ‰é’®', true, 
                    `æˆåŠŸæ‰¾åˆ°è¡¨å•å…ƒç´ ï¼ŒIDåŒ¹é…æ­£ç¡®`, 
                    `ä½¿ç”¨çš„formId: ${returnedFormId2}\nè¡¨å•å…ƒç´ å­˜åœ¨: ${formElement !== null}`);
            } else {
                addTestResult(3, 'æ¨¡æ‹Ÿç‚¹å‡»æ‰§è¡ŒæŒ‰é’®', false, 
                    `æ— æ³•æ‰¾åˆ°è¡¨å•å…ƒç´ ï¼ˆIDä¸åŒ¹é…ï¼‰`, 
                    `ä½¿ç”¨çš„formId: ${returnedFormId2}\nè¡¨å•å…ƒç´ å­˜åœ¨: ${formElement !== null}`);
                return;
            }
            
            // Test Step 4: Simulate receiving diagnosis event
            addTestResult(4, 'æ¨¡æ‹Ÿæ¥æ”¶è¯Šæ–­äº‹ä»¶', false, 'å‡†å¤‡æµ‹è¯•...', '');
            const diagnosisDiv = document.createElement('div');
            diagnosisDiv.id = 'diagnosis-content';
            diagnosisDiv.className = 'alert alert-info';
            diagnosisDiv.innerHTML = '<h5>ğŸ“Š æ•°æ®ä½“æ£€æŠ¥å‘Š</h5><p>æ ·æœ¬æ•°: 100, ç‰¹å¾æ•°: 50</p>';
            document.getElementById('card-zone').appendChild(diagnosisDiv);
            
            const diagnosisExists = document.getElementById('diagnosis-content') !== null;
            if (diagnosisExists) {
                addTestResult(4, 'æ¨¡æ‹Ÿæ¥æ”¶è¯Šæ–­äº‹ä»¶', true, 
                    `è¯Šæ–­éƒ¨åˆ†å·²æˆåŠŸæ¸²æŸ“`, 
                    `è¯Šæ–­å…ƒç´ å­˜åœ¨: ${diagnosisExists}`);
            } else {
                addTestResult(4, 'æ¨¡æ‹Ÿæ¥æ”¶è¯Šæ–­äº‹ä»¶', false, 
                    `è¯Šæ–­éƒ¨åˆ†æ¸²æŸ“å¤±è´¥`, 
                    `è¯Šæ–­å…ƒç´ å­˜åœ¨: ${diagnosisExists}`);
            }
            
            // Final summary
            const allTests = document.querySelectorAll('.test-result');
            const passedTests = Array.from(allTests).filter(r => r.classList.contains('pass')).length;
            const totalTests = allTests.length;
            
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'test-step';
            summaryDiv.style.background = passedTests === totalTests ? '#d4edda' : '#f8d7da';
            summaryDiv.innerHTML = `
                <h3>ğŸ“Š æµ‹è¯•æ€»ç»“</h3>
                <div class="test-result ${passedTests === totalTests ? 'pass' : 'fail'}">
                    ${passedTests === totalTests ? 'âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡' : 'âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥'}: ${passedTests}/${totalTests}
                </div>
            `;
            resultsDiv.appendChild(summaryDiv);
        }
        
        // Auto-run tests on load (optional)
        // window.addEventListener('DOMContentLoaded', () => {
        //     setTimeout(runAllTests, 1000);
        // });
    </script>
</body>
</html>
