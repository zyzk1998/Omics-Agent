<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omics Agent - Thin Client</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4d6bfe;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --bg-light: #f8f9fa;
            --border-color: #dee2e6;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-light);
            padding: 20px;
            margin: 0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 8px;
            font-size: 28px;
            font-weight: 600;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 24px;
            background: var(--bg-light);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .section h3 {
            margin-top: 0;
            margin-bottom: 16px;
            color: var(--primary-color);
            font-size: 20px;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            font-weight: 500;
            color: #333;
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(77, 107, 254, 0.1);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        button:hover:not(:disabled) {
            background: #3d5bfe;
            transform: translateY(-1px);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .response-box {
            margin-top: 20px;
            padding: 16px;
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 6px;
            font-family: 'Courier New', 'Consolas', monospace;
            font-size: 13px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        .status {
            padding: 10px 14px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .file-info {
            margin-top: 12px;
            padding: 12px;
            background: #e9ecef;
            border-radius: 6px;
            font-size: 13px;
            border: 1px solid var(--border-color);
        }
        
        .file-list {
            margin-top: 12px;
            padding: 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-item-name {
            font-weight: 500;
            color: #333;
        }
        
        .file-item-size {
            color: #666;
            font-size: 12px;
        }
        
        .remove-file-btn {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-file-btn:hover {
            background: #c82333;
        }
        
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            font-family: 'Courier New', 'Consolas', monospace;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .api-info {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
            margin-top: 16px;
        }
        
        .api-info h4 {
            margin-top: 0;
            margin-bottom: 12px;
            color: var(--primary-color);
            font-size: 16px;
        }
        
        .api-info ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .api-info li {
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .sse-event {
            margin-bottom: 8px;
            padding: 8px;
            background: #2d2d2d;
            border-radius: 4px;
            border-left: 3px solid var(--primary-color);
        }
        
        .sse-event-type {
            color: #4d6bfe;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .sse-event-data {
            color: #d4d4d4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Omics Agent - Thin Client</h1>
        <p class="subtitle">è½»é‡çº§å‰ç«¯æ¼”ç¤º - å±•ç¤ºå¦‚ä½•ä¸åç«¯ API é›†æˆ</p>

        <!-- æ–‡ä»¶ä¸Šä¼ éƒ¨åˆ† -->
        <div class="section">
            <h3>ğŸ“¤ 1. æ–‡ä»¶ä¸Šä¼  API</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 16px;">
                ä¸Šä¼ æ–‡ä»¶åˆ° <code>POST /api/upload</code>ï¼Œæ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ å’Œ 10x Genomics æ•°æ®è‡ªåŠ¨è¯†åˆ«
            </p>
            <div class="form-group">
                <label for="fileInput">é€‰æ‹©æ–‡ä»¶:</label>
                <input type="file" id="fileInput" accept=".csv,.tsv,.txt,.h5ad,.mtx,.gz,.tar,.zip" multiple>
                <div id="fileStatus" style="margin-top: 12px;"></div>
                <div id="fileList" class="file-list" style="display: none;"></div>
            </div>
            <button onclick="uploadFile()" id="uploadBtn">ä¸Šä¼ æ–‡ä»¶</button>
            <div id="uploadResponse" class="response-box" style="display: none;"></div>
        </div>

        <!-- èŠå¤©éƒ¨åˆ† -->
        <div class="section">
            <h3>ğŸ’¬ 2. èŠå¤© API</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 16px;">
                å‘é€æ¶ˆæ¯åˆ° <code>POST /api/chat</code>ï¼Œæ”¯æŒæµå¼å“åº”ï¼ˆSSEï¼‰å’Œ JSON å“åº”
            </p>
            <div class="form-group">
                <label for="queryInput">ç”¨æˆ·æŸ¥è¯¢:</label>
                <textarea id="queryInput" placeholder="ä¾‹å¦‚: åˆ†æè¿™ä¸ªæ•°æ®æ–‡ä»¶"></textarea>
            </div>
            <div class="form-group">
                <label for="userInput">ç”¨æˆ·ID (å¯é€‰):</label>
                <input type="text" id="userInput" placeholder="guest" value="guest">
            </div>
            <div class="form-group">
                <label for="sessionInput">ä¼šè¯ID (å¯é€‰):</label>
                <input type="text" id="sessionInput" placeholder="è‡ªåŠ¨ç”Ÿæˆ">
            </div>
            <div class="form-group checkbox-group">
                <input type="checkbox" id="useStream" checked>
                <label for="useStream" style="margin: 0;">ä½¿ç”¨æµå¼è¾“å‡ºï¼ˆServer-Sent Eventsï¼‰</label>
            </div>
            <button onclick="sendMessage()" id="chatBtn">å‘é€æ¶ˆæ¯</button>
            <div id="chatResponse" class="response-box" style="display: none;"></div>
        </div>

        <!-- API è¯´æ˜ -->
        <div class="section">
            <h3>ğŸ“š API æ¥å£è¯´æ˜</h3>
            <div class="api-info">
                <h4>1. æ–‡ä»¶ä¸Šä¼ æ¥å£</h4>
                <ul>
                    <li><strong>Endpoint:</strong> <code>POST /api/upload</code></li>
                    <li><strong>Content-Type:</strong> <code>multipart/form-data</code></li>
                    <li><strong>è¯·æ±‚å‚æ•°:</strong> <code>files</code> (File[]), <code>user_id</code> (å¯é€‰), <code>session_id</code> (å¯é€‰)</li>
                    <li><strong>å“åº”æ ¼å¼:</strong> JSON</li>
                    <li><strong>å“åº”å­—æ®µ:</strong> <code>status</code>, <code>file_paths</code> (æ•°ç»„), <code>file_info</code> (æ•°ç»„), <code>user_id</code>, <code>session_id</code></li>
                    <li><strong>ç‰¹æ®Šå¤„ç†:</strong> è‡ªåŠ¨è¯†åˆ« 10x Genomics æ•°æ®ï¼ˆmatrix.mtx, barcodes.tsv, features.tsvï¼‰å¹¶åˆ†ç»„ä¿å­˜</li>
                </ul>
            </div>
            
            <div class="api-info" style="margin-top: 16px;">
                <h4>2. èŠå¤©æ¥å£</h4>
                <ul>
                    <li><strong>Endpoint:</strong> <code>POST /api/chat</code></li>
                    <li><strong>Content-Type:</strong> <code>application/json</code></li>
                    <li><strong>è¯·æ±‚ä½“å­—æ®µ:</strong>
                        <ul style="margin-top: 8px;">
                            <li><code>message</code> (string): ç”¨æˆ·æ¶ˆæ¯</li>
                            <li><code>uploaded_files</code> (array): å·²ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ï¼Œæ ¼å¼: <code>[{"name": "file.csv", "path": "path/to/file.csv"}]</code></li>
                            <li><code>stream</code> (boolean): æ˜¯å¦ä½¿ç”¨æµå¼å“åº”ï¼Œé»˜è®¤ false</li>
                            <li><code>user_id</code> (string, å¯é€‰): ç”¨æˆ·IDï¼Œé»˜è®¤ "guest"</li>
                            <li><code>session_id</code> (string, å¯é€‰): ä¼šè¯IDï¼Œæœªæä¾›æ—¶è‡ªåŠ¨ç”Ÿæˆ</li>
                            <li><code>history</code> (array, å¯é€‰): å¯¹è¯å†å²</li>
                            <li><code>workflow_data</code> (object, å¯é€‰): å·¥ä½œæµæ‰§è¡Œæ•°æ®</li>
                        </ul>
                    </li>
                    <li><strong>å“åº”ç±»å‹:</strong> 
                        <ul style="margin-top: 8px;">
                            <li><strong>æµå¼å“åº” (SSE):</strong> <code>text/event-stream</code>ï¼Œäº‹ä»¶ç±»å‹åŒ…æ‹¬: <code>status</code>, <code>message</code>, <code>workflow</code>, <code>step_result</code>, <code>diagnosis</code>, <code>result</code>, <code>done</code>, <code>error</code></li>
                            <li><strong>JSON å“åº”:</strong> <code>application/json</code>ï¼ŒåŒ…å« <code>type</code> å­—æ®µï¼ˆå¦‚ <code>workflow_config</code>, <code>analysis_report</code>ï¼‰</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let uploadedFiles = [];
        let currentSessionId = null;

        // æ–‡ä»¶ä¸Šä¼ 
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const fileStatus = document.getElementById('fileStatus');
            const uploadResponse = document.getElementById('uploadResponse');
            const fileList = document.getElementById('fileList');

            if (!fileInput.files || fileInput.files.length === 0) {
                fileStatus.innerHTML = '<div class="status error">è¯·é€‰æ‹©æ–‡ä»¶</div>';
                return;
            }

            uploadBtn.disabled = true;
            fileStatus.innerHTML = '<div class="status info">ä¸Šä¼ ä¸­...</div>';
            uploadResponse.style.display = 'none';

            try {
                const formData = new FormData();
                for (let file of fileInput.files) {
                    formData.append('files', file);
                }
                
                // å¯é€‰ï¼šæ·»åŠ  user_id å’Œ session_id
                const userId = document.getElementById('userInput').value || 'guest';
                const sessionId = document.getElementById('sessionInput').value;
                if (userId) formData.append('user_id', userId);
                if (sessionId) formData.append('session_id', sessionId);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    fileStatus.innerHTML = '<div class="status success">ä¸Šä¼ æˆåŠŸï¼</div>';
                    
                    // æ›´æ–°ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
                    uploadedFiles = result.file_paths || [];
                    if (result.session_id) {
                        currentSessionId = result.session_id;
                        document.getElementById('sessionInput').value = result.session_id;
                    }
                    
                    // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
                    if (uploadedFiles.length > 0) {
                        fileList.style.display = 'block';
                        fileList.innerHTML = '<strong>å·²ä¸Šä¼ çš„æ–‡ä»¶:</strong><br>';
                        uploadedFiles.forEach((path, index) => {
                            const fileName = path.split('/').pop();
                            fileList.innerHTML += `
                                <div class="file-item">
                                    <span class="file-item-name">${fileName}</span>
                                    <span class="file-item-size">${path}</span>
                                </div>
                            `;
                        });
                    }
                    
                    // æ˜¾ç¤ºå“åº” JSON
                    uploadResponse.style.display = 'block';
                    uploadResponse.textContent = JSON.stringify(result, null, 2);
                } else {
                    fileStatus.innerHTML = `<div class="status error">ä¸Šä¼ å¤±è´¥: ${result.error || result.detail || 'Unknown error'}</div>`;
                    uploadResponse.style.display = 'block';
                    uploadResponse.textContent = JSON.stringify(result, null, 2);
                }
            } catch (error) {
                fileStatus.innerHTML = `<div class="status error">é”™è¯¯: ${error.message}</div>`;
                uploadResponse.style.display = 'block';
                uploadResponse.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
            } finally {
                uploadBtn.disabled = false;
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const queryInput = document.getElementById('queryInput');
            const chatBtn = document.getElementById('chatBtn');
            const chatResponse = document.getElementById('chatResponse');
            const useStream = document.getElementById('useStream').checked;
            const userId = document.getElementById('userInput').value || 'guest';
            const sessionId = document.getElementById('sessionInput').value || currentSessionId;

            const query = queryInput.value.trim();
            if (!query && uploadedFiles.length === 0) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹æˆ–ä¸Šä¼ æ–‡ä»¶');
                return;
            }

            chatBtn.disabled = true;
            chatResponse.style.display = 'block';
            chatResponse.textContent = 'å‘é€ä¸­...\n\n';

            try {
                // æ„å»ºè¯·æ±‚ä½“
                const requestBody = {
                    message: query,
                    uploaded_files: uploadedFiles.map(path => ({
                        name: path.split('/').pop(),
                        path: path
                    })),
                    stream: useStream,
                    user_id: userId,
                    session_id: sessionId || undefined
                };

                if (useStream) {
                    // æµå¼è¾“å‡ºï¼ˆSSEï¼‰
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let fullResponse = 'æµå¼å“åº”:\n\n';

                    chatResponse.textContent = fullResponse;

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (line.startsWith('event: ')) {
                                const eventType = line.substring(7).trim();
                                fullResponse += `\n[äº‹ä»¶ç±»å‹: ${eventType}]\n`;
                                
                                // ğŸ”¥ TASK 2: å¤„ç† Cell Ranger ç­‰å¾…æ°”æ³¡
                                if (eventType === 'status') {
                                    // åœ¨ä¸‹ä¸€ä¸ª data è¡Œå¤„ç†
                                }
                            } else if (line.startsWith('data: ')) {
                                const dataStr = line.substring(6).trim();
                                try {
                                    const data = JSON.parse(dataStr);
                                    fullResponse += JSON.stringify(data, null, 2) + '\n\n';
                                    
                                    // ğŸ”¥ TASK 2: æ£€æµ‹å¹¶æ˜¾ç¤ºç­‰å¾…æ°”æ³¡
                                    if (data.show_waiting_bubble) {
                                        console.log('â³ æ˜¾ç¤ºç­‰å¾…æ°”æ³¡:', data.waiting_message || data.content);
                                        // åœ¨ç˜¦å‰ç«¯ä¸­ï¼Œå¯ä»¥ç®€å•åœ°åœ¨æ§åˆ¶å°æ˜¾ç¤ºæˆ–æ·»åŠ ä¸€ä¸ªç®€å•çš„æç¤º
                                        fullResponse += `\n[æç¤º] ${data.waiting_message || data.content}\n\n`;
                                    }
                                    
                                    // ğŸ”¥ TASK 2 & 3: å¤„ç†æµ‹è¯•æ•°æ®è¯¢é—®ï¼ˆæ”¯æŒå–æ¶ˆå’Œæ¨èæ•°æ®ï¼‰
                                    if (data.test_data_question) {
                                        const question = data.test_data_question;
                                        
                                        // æ„å»ºç¡®è®¤æ¶ˆæ¯
                                        let confirmMessage = `${question.question}\n\n${question.message}\n\n`;
                                        
                                        // å¦‚æœæœ‰æ¨èçš„æ•°æ®é›†ï¼Œæ˜¾ç¤ºå®ƒä»¬
                                        if (question.recommended_datasets && question.recommended_datasets.length > 0) {
                                            confirmMessage += 'æ¨èæµ‹è¯•æ•°æ®ï¼š\n';
                                            question.recommended_datasets.forEach((ds, idx) => {
                                                confirmMessage += `${idx + 1}. ${ds.name} (${ds.workflow_type || 'é€šç”¨'})\n`;
                                                confirmMessage += `   ${ds.description}\n`;
                                            });
                                            confirmMessage += '\n';
                                        } else if (question.test_data_info) {
                                            confirmMessage += `æµ‹è¯•æ•°æ®: ${question.test_data_info.name || 'N/A'}\n`;
                                            confirmMessage += `æè¿°: ${question.test_data_info.description || 'N/A'}\n`;
                                            confirmMessage += `å¤§å°: ${question.test_data_info.size || 'N/A'}\n\n`;
                                        }
                                        
                                        confirmMessage += 'æ˜¯å¦ä½¿ç”¨æµ‹è¯•æ•°æ®ï¼Ÿ';
                                        
                                        const confirmed = confirm(confirmMessage);
                                        if (confirmed) {
                                            // ä½¿ç”¨æµ‹è¯•æ•°æ®é‡æ–°å‘é€è¯·æ±‚
                                            uploadedFiles = [{
                                                name: question.test_data_info?.name || 'test_data',
                                                path: question.test_data_path
                                            }];
                                            sendMessage();
                                            return; // åœæ­¢å½“å‰æµ
                                        } else {
                                            // ğŸ”¥ TASK 2: ç”¨æˆ·ç‚¹å‡»å–æ¶ˆï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                                            fullResponse += '\n\n[æç¤º] å·²å–æ¶ˆæµ‹è¯•æ•°æ®é€‰æ‹©ã€‚æ‚¨å¯ä»¥ä¸Šä¼ è‡ªå·±çš„æ•°æ®æ–‡ä»¶ç»§ç»­åˆ†æã€‚\n\n';
                                            chatResponse.textContent = fullResponse;
                                            return; // åœæ­¢å½“å‰æµï¼Œç­‰å¾…ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
                                        }
                                    }
                                } catch (e) {
                                    fullResponse += dataStr + '\n\n';
                                }
                            }
                        }

                        chatResponse.textContent = fullResponse;
                    }
                } else {
                    // éæµå¼è¾“å‡ºï¼ˆJSONï¼‰
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    const result = await response.json();
                    chatResponse.textContent = JSON.stringify(result, null, 2);
                }
            } catch (error) {
                chatResponse.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
            } finally {
                chatBtn.disabled = false;
            }
        }

        // æ–‡ä»¶é€‰æ‹©æç¤º
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const fileStatus = document.getElementById('fileStatus');
            const fileList = document.getElementById('fileList');
            
            if (e.target.files && e.target.files.length > 0) {
                let fileInfo = '<div class="file-info"><strong>å·²é€‰æ‹©æ–‡ä»¶:</strong><br>';
                let totalSize = 0;
                
                for (let file of e.target.files) {
                    const size = (file.size / 1024).toFixed(2);
                    totalSize += file.size;
                    fileInfo += `â€¢ ${file.name} (${size} KB)<br>`;
                }
                
                fileInfo += `<br><strong>æ€»è®¡:</strong> ${(totalSize / 1024).toFixed(2)} KB (${e.target.files.length} ä¸ªæ–‡ä»¶)`;
                fileInfo += '</div>';
                
                fileStatus.innerHTML = fileInfo;
            } else {
                fileStatus.innerHTML = '';
            }
        });

        // è‡ªåŠ¨ç”Ÿæˆä¼šè¯IDï¼ˆå¦‚æœæœªæä¾›ï¼‰
        if (!document.getElementById('sessionInput').value) {
            currentSessionId = 'session_' + Date.now();
            document.getElementById('sessionInput').value = currentSessionId;
        }
    </script>
</body>
</html>
