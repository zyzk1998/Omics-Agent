<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶è—å·¥ä½œæµåŠŸèƒ½æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .btn-test {
            margin: 5px;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ æ”¶è—å·¥ä½œæµåŠŸèƒ½æµ‹è¯•</h1>
        <p class="text-muted">æ­¤é¡µé¢ç”¨äºæµ‹è¯•æ”¶è—å·¥ä½œæµåŠŸèƒ½çš„å„ä¸ªç»„ä»¶æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
        
        <!-- æµ‹è¯• 1: æ£€æŸ¥ renderWorkflowCard å‡½æ•° -->
        <div class="test-section">
            <h3>æµ‹è¯• 1: æ£€æŸ¥ renderWorkflowCard å‡½æ•°æ˜¯å¦å¯ç”¨</h3>
            <button class="btn btn-primary btn-test" onclick="testRenderWorkflowCard()">æµ‹è¯• renderWorkflowCard</button>
            <div id="test1-result"></div>
        </div>
        
        <!-- æµ‹è¯• 2: æµ‹è¯•æ”¶è—åŠŸèƒ½ -->
        <div class="test-section">
            <h3>æµ‹è¯• 2: æµ‹è¯•æ”¶è—å·¥ä½œæµåŠŸèƒ½</h3>
            <button class="btn btn-primary btn-test" onclick="testAddFavorite()">æ·»åŠ æµ‹è¯•æ”¶è—</button>
            <button class="btn btn-secondary btn-test" onclick="testListFavorites()">åˆ—å‡ºæ‰€æœ‰æ”¶è—</button>
            <button class="btn btn-danger btn-test" onclick="testClearFavorites()">æ¸…ç©ºæ”¶è—</button>
            <div id="test2-result"></div>
        </div>
        
        <!-- æµ‹è¯• 3: æµ‹è¯•ä½¿ç”¨æ”¶è—çš„å·¥ä½œæµ -->
        <div class="test-section">
            <h3>æµ‹è¯• 3: æµ‹è¯•ä½¿ç”¨æ”¶è—çš„å·¥ä½œæµ</h3>
            <button class="btn btn-primary btn-test" onclick="testUseFavorite()">ä½¿ç”¨ç¬¬ä¸€ä¸ªæ”¶è—</button>
            <div id="test3-result"></div>
        </div>
        
        <!-- æµ‹è¯• 4: æµ‹è¯•å·¥ä½œæµæ•°æ®æ ¼å¼ -->
        <div class="test-section">
            <h3>æµ‹è¯• 4: éªŒè¯å·¥ä½œæµæ•°æ®æ ¼å¼</h3>
            <button class="btn btn-primary btn-test" onclick="testWorkflowFormat()">éªŒè¯æ ¼å¼</button>
            <div id="test4-result"></div>
        </div>
        
        <!-- æµ‹è¯•ç»“æœæ±‡æ€» -->
        <div class="test-section">
            <h3>æµ‹è¯•ç»“æœæ±‡æ€»</h3>
            <button class="btn btn-success btn-test" onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <div id="summary-result"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿå·¥ä½œæµæ•°æ®
        const mockWorkflowData = {
            workflow_name: "RNA åˆ†æå…¨æµç¨‹",
            steps: [
                {
                    step_id: "step_1",
                    tool_id: "rna_convert_cellranger_to_h5ad",
                    step_name: "è½¬æ¢ Cell Ranger è¾“å‡º",
                    parameters: {
                        cellranger_matrix_dir: "/path/to/matrix"
                    }
                },
                {
                    step_id: "step_2",
                    tool_id: "rna_qc_filter",
                    step_name: "è´¨æ§è¿‡æ»¤",
                    parameters: {
                        min_genes: 200,
                        max_genes: 5000,
                        max_mt: 0.2
                    }
                }
            ],
            workflow_data: {
                workflow_name: "RNA åˆ†æå…¨æµç¨‹",
                steps: [
                    {
                        step_id: "step_1",
                        tool_id: "rna_convert_cellranger_to_h5ad",
                        step_name: "è½¬æ¢ Cell Ranger è¾“å‡º"
                    },
                    {
                        step_id: "step_2",
                        tool_id: "rna_qc_filter",
                        step_name: "è´¨æ§è¿‡æ»¤"
                    }
                ]
            }
        };

        // æµ‹è¯• 1: æ£€æŸ¥ renderWorkflowCard å‡½æ•°
        function testRenderWorkflowCard() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.innerHTML = '';
            
            try {
                // æ£€æŸ¥æ˜¯å¦åœ¨ window å¯¹è±¡ä¸Š
                if (typeof window.renderWorkflowCard === 'function') {
                    resultDiv.innerHTML = '<div class="test-result success">âœ… renderWorkflowCard å‡½æ•°å·²å®šä¹‰åœ¨ window å¯¹è±¡ä¸Š</div>';
                } else {
                    resultDiv.innerHTML = '<div class="test-result error">âŒ renderWorkflowCard å‡½æ•°æœªå®šä¹‰ã€‚è¯·ç¡®ä¿åœ¨ index.html ä¸­å·²æ­£ç¡®å®šä¹‰ window.renderWorkflowCard</div>';
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ æµ‹è¯•å‡ºé”™: ${e.message}</div>`;
            }
        }

        // æµ‹è¯• 2: æµ‹è¯•æ”¶è—åŠŸèƒ½
        function testAddFavorite() {
            const resultDiv = document.getElementById('test2-result');
            resultDiv.innerHTML = '';
            
            try {
                // æ£€æŸ¥ localStorage æ˜¯å¦å¯ç”¨
                if (typeof Storage === 'undefined') {
                    resultDiv.innerHTML = '<div class="test-result error">âŒ localStorage ä¸å¯ç”¨</div>';
                    return;
                }
                
                // è·å–ç°æœ‰æ”¶è—
                let favorites = JSON.parse(localStorage.getItem('favorite_workflows') || '[]');
                
                // æ·»åŠ æµ‹è¯•æ”¶è—
                const testFavorite = {
                    id: 'test_' + Date.now(),
                    name: 'æµ‹è¯•å·¥ä½œæµ ' + new Date().toLocaleTimeString(),
                    workflowData: mockWorkflowData,
                    createdAt: new Date().toISOString()
                };
                
                favorites.push(testFavorite);
                localStorage.setItem('favorite_workflows', JSON.stringify(favorites));
                
                resultDiv.innerHTML = `<div class="test-result success">âœ… æˆåŠŸæ·»åŠ æµ‹è¯•æ”¶è— (ID: ${testFavorite.id})</div>`;
            } catch (e) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ æµ‹è¯•å‡ºé”™: ${e.message}</div>`;
            }
        }

        function testListFavorites() {
            const resultDiv = document.getElementById('test2-result');
            resultDiv.innerHTML = '';
            
            try {
                const favorites = JSON.parse(localStorage.getItem('favorite_workflows') || '[]');
                
                if (favorites.length === 0) {
                    resultDiv.innerHTML = '<div class="test-result info">â„¹ï¸ æš‚æ— æ”¶è—</div>';
                } else {
                    let html = `<div class="test-result success">âœ… æ‰¾åˆ° ${favorites.length} ä¸ªæ”¶è—ï¼š</div><ul>`;
                    favorites.forEach(fav => {
                        html += `<li><strong>${fav.name}</strong> (ID: ${fav.id})</li>`;
                    });
                    html += '</ul>';
                    resultDiv.innerHTML = html;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ æµ‹è¯•å‡ºé”™: ${e.message}</div>`;
            }
        }

        function testClearFavorites() {
            const resultDiv = document.getElementById('test2-result');
            resultDiv.innerHTML = '';
            
            try {
                localStorage.removeItem('favorite_workflows');
                resultDiv.innerHTML = '<div class="test-result success">âœ… å·²æ¸…ç©ºæ‰€æœ‰æ”¶è—</div>';
            } catch (e) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ æµ‹è¯•å‡ºé”™: ${e.message}</div>`;
            }
        }

        // æµ‹è¯• 3: æµ‹è¯•ä½¿ç”¨æ”¶è—çš„å·¥ä½œæµ
        function testUseFavorite() {
            const resultDiv = document.getElementById('test3-result');
            resultDiv.innerHTML = '';
            
            try {
                const favorites = JSON.parse(localStorage.getItem('favorite_workflows') || '[]');
                
                if (favorites.length === 0) {
                    resultDiv.innerHTML = '<div class="test-result error">âŒ æ²¡æœ‰å¯ç”¨çš„æ”¶è—ï¼Œè¯·å…ˆæ·»åŠ æ”¶è—</div>';
                    return;
                }
                
                const favorite = favorites[0];
                
                // æ£€æŸ¥ renderWorkflowCard æ˜¯å¦å¯ç”¨
                if (typeof window.renderWorkflowCard === 'function') {
                    // æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯æµ‹è¯•è°ƒç”¨ï¼Œä¸ä¼šçœŸæ­£æ¸²æŸ“ï¼ˆå› ä¸ºä¸åœ¨ index.html ç¯å¢ƒä¸­ï¼‰
                    resultDiv.innerHTML = `<div class="test-result success">âœ… å¯ä»¥è°ƒç”¨ renderWorkflowCardï¼Œæ”¶è—æ•°æ®æ ¼å¼æ­£ç¡® (ID: ${favorite.id})</div>`;
                } else {
                    resultDiv.innerHTML = '<div class="test-result error">âŒ renderWorkflowCard å‡½æ•°ä¸å¯ç”¨ã€‚è¯·ç¡®ä¿åœ¨ index.html ä¸­å·²æ­£ç¡®å®šä¹‰</div>';
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ æµ‹è¯•å‡ºé”™: ${e.message}</div>`;
            }
        }

        // æµ‹è¯• 4: éªŒè¯å·¥ä½œæµæ•°æ®æ ¼å¼
        function testWorkflowFormat() {
            const resultDiv = document.getElementById('test4-result');
            resultDiv.innerHTML = '';
            
            try {
                const favorites = JSON.parse(localStorage.getItem('favorite_workflows') || '[]');
                
                if (favorites.length === 0) {
                    resultDiv.innerHTML = '<div class="test-result info">â„¹ï¸ æ²¡æœ‰æ”¶è—å¯éªŒè¯</div>';
                    return;
                }
                
                let allValid = true;
                let errors = [];
                
                favorites.forEach((fav, idx) => {
                    if (!fav.id) {
                        allValid = false;
                        errors.push(`æ”¶è— ${idx + 1}: ç¼ºå°‘ id`);
                    }
                    if (!fav.name) {
                        allValid = false;
                        errors.push(`æ”¶è— ${idx + 1}: ç¼ºå°‘ name`);
                    }
                    if (!fav.workflowData) {
                        allValid = false;
                        errors.push(`æ”¶è— ${idx + 1}: ç¼ºå°‘ workflowData`);
                    } else {
                        if (!fav.workflowData.workflow_data && !fav.workflowData.steps) {
                            allValid = false;
                            errors.push(`æ”¶è— ${idx + 1}: workflowData æ ¼å¼ä¸æ­£ç¡®`);
                        }
                    }
                });
                
                if (allValid) {
                    resultDiv.innerHTML = `<div class="test-result success">âœ… æ‰€æœ‰æ”¶è—çš„æ•°æ®æ ¼å¼æ­£ç¡® (${favorites.length} ä¸ª)</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="test-result error">âŒ å‘ç°æ ¼å¼é”™è¯¯ï¼š<ul>${errors.map(e => '<li>' + e + '</li>').join('')}</ul></div>`;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ æµ‹è¯•å‡ºé”™: ${e.message}</div>`;
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        function runAllTests() {
            const summaryDiv = document.getElementById('summary-result');
            summaryDiv.innerHTML = '<div class="test-result info">ğŸ”„ æ­£åœ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•...</div>';
            
            setTimeout(() => {
                testRenderWorkflowCard();
                testListFavorites();
                testWorkflowFormat();
                
                const favorites = JSON.parse(localStorage.getItem('favorite_workflows') || '[]');
                const hasRenderWorkflowCard = typeof window.renderWorkflowCard === 'function';
                
                let summary = '<h4>æµ‹è¯•æ±‡æ€»ï¼š</h4><ul>';
                summary += `<li>renderWorkflowCard å‡½æ•°: ${hasRenderWorkflowCard ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}</li>`;
                summary += `<li>æ”¶è—æ•°é‡: ${favorites.length}</li>`;
                summary += `<li>æ•°æ®æ ¼å¼: ${favorites.length > 0 ? 'âœ… å·²éªŒè¯' : 'â„¹ï¸ æ— æ•°æ®'}</li>`;
                summary += '</ul>';
                
                if (hasRenderWorkflowCard && favorites.length > 0) {
                    summary += '<div class="test-result success">âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ”¶è—å·¥ä½œæµåŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚</div>';
                } else if (!hasRenderWorkflowCard) {
                    summary += '<div class="test-result error">âŒ renderWorkflowCard å‡½æ•°ä¸å¯ç”¨ã€‚è¯·ç¡®ä¿åœ¨ index.html ä¸­å·²æ­£ç¡®å®šä¹‰ window.renderWorkflowCard</div>';
                } else {
                    summary += '<div class="test-result info">â„¹ï¸ è¯·å…ˆæ·»åŠ ä¸€äº›æ”¶è—ï¼Œç„¶åå†æ¬¡è¿è¡Œæµ‹è¯•ã€‚</div>';
                }
                
                summaryDiv.innerHTML = summary;
            }, 500);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯• 1
        window.addEventListener('load', () => {
            testRenderWorkflowCard();
        });
    </script>
</body>
</html>
