# Promptä¼˜åŒ–æ€»ç»“ - è§£å†³JSONè¿‡é•¿é—®é¢˜

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šJSONæ€»é•¿è¶…è¿‡6000ä¸ªå­—ç¬¦ï¼Œå®Œå…¨è¶…è¿‡LLMå¯è¾“å…¥é•¿åº¦ã€‚éœ€è¦é‡‡å–æ²»æœ¬ä¹‹ç­–ï¼Œä¸è¦å®Œå…¨è¾“å…¥å®Œæ•´æ‰§è¡Œç»“æœï¼Œè€Œæ˜¯é€šè¿‡æ‰§è¡Œç»“æœæå–æ ¸å¿ƒå­—æ®µã€è¿‡æ»¤å†—ä½™ä¿¡æ¯ï¼Œç”ŸæˆLLMå¯å¤„ç†çš„ç²¾ç®€JSONã€‚

## æ ¹æœ¬åŸå› 

1. **`step_result.data`åŒ…å«å®Œæ•´æ•°æ®**ï¼šåŒ…æ‹¬`file_path`ã€`preview`ã€å®Œæ•´çš„`results`åˆ—è¡¨ç­‰å¤§å‹æ•°æ®
2. **`summary_json`åŒ…å«å†—ä½™ä¿¡æ¯**ï¼šæ¯ä¸ªæ­¥éª¤çš„`step_info`åŒ…å«è¿‡å¤šå­—æ®µ
3. **`key_findings_json`å¯èƒ½åŒ…å«å¤§å‹æ•°ç»„**ï¼šå¦‚å®Œæ•´çš„`top_up`ã€`top_down`åˆ—è¡¨
4. **`execution_results_text`åŒ…å«CSVå®Œæ•´è¡Œæ•°æ®**ï¼šå¯¼è‡´æ–‡æœ¬è¿‡é•¿

## ä¿®å¤æ–¹æ¡ˆ

### 1. ç²¾ç®€`step_info`æå–é€»è¾‘

**ä¿®å¤ä½ç½®**ï¼š`gibh_agent/agents/base_agent.py` ç¬¬866-1027è¡Œ

**ä¿®å¤å†…å®¹**ï¼š
- âœ… åªä»`summary`ä¸­æå–å…³é”®æŒ‡æ ‡ï¼Œä¸åŒ…å«`data`ä¸­çš„å…¶ä»–å­—æ®µ
- âœ… ä¸åŒ…å«`file_path`ã€`preview`ã€å®Œæ•´çš„`results`åˆ—è¡¨ç­‰å¤§å‹æ•°æ®
- âœ… é™åˆ¶topæ ‡è®°ç‰©æ•°é‡ï¼ˆä»5ä¸ªå‡å°‘åˆ°3ä¸ªï¼‰
- âœ… åªä¿ç•™æ ‡è®°ç‰©åç§°ï¼Œä¸åŒ…å«å®Œæ•´çš„log2fcã€fdrç­‰è¯¦ç»†æ•°æ®
- âœ… ç§»é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„å†—ä½™å­—æ®µï¼ˆ`file_path`ã€`output_path`ã€`preview`ã€`results`ã€`vip_scores`ã€`enriched_pathways`ã€`explained_variance`ï¼‰

**å…·ä½“ä¿®æ”¹**ï¼š
- **å·®å¼‚åˆ†æ**ï¼šåªä»`summary.top_markers`æå–top 3åç§°ï¼Œä¸å¤„ç†å®Œæ•´çš„`results`åˆ—è¡¨
- **PLS-DA**ï¼šåªä»`summary.top_vip_markers`æå–top 3åç§°ï¼Œä¸å¤„ç†å®Œæ•´çš„`vip_scores`åˆ—è¡¨
- **é€šè·¯å¯Œé›†**ï¼šåªä»`summary.top_pathways`æå–top 3åç§°ï¼Œä¸å¤„ç†å®Œæ•´çš„`enriched_pathways`åˆ—è¡¨
- **PCA**ï¼šåªä¿ç•™æ ¼å¼åŒ–åçš„ç™¾åˆ†æ¯”ï¼Œä¸åŒ…å«åŸå§‹çš„`pc1_var`ã€`pc2_var`ç­‰æ•°å€¼

### 2. ç²¾ç®€`compact_summary`æ„å»º

**ä¿®å¤ä½ç½®**ï¼š`gibh_agent/agents/base_agent.py` ç¬¬1029-1051è¡Œ

**ä¿®å¤å†…å®¹**ï¼š
- âœ… åªä¿ç•™æœ€æ ¸å¿ƒçš„æŒ‡æ ‡
- âœ… æ ‡è®°ç‰©åªä¿ç•™åç§°åˆ—è¡¨ï¼ˆ`top_marker_names`ã€`top_vip_names`ã€`top_pathway_names`ï¼‰
- âœ… ç§»é™¤æ‰€æœ‰å†—ä½™å­—æ®µï¼ˆ`method`ã€`case_group`ã€`control_group`ã€`n_components`ç­‰ï¼‰
- âœ… é™åˆ¶æ¯ä¸ªæ­¥éª¤åªåŒ…å«3-5ä¸ªå…³é”®å­—æ®µ

**å­—æ®µæ˜ å°„**ï¼š
- `top_markers` â†’ `top_marker_names`ï¼ˆåªä¿ç•™åç§°ï¼‰
- `top_vip_markers` â†’ `top_vip_names`ï¼ˆåªä¿ç•™åç§°ï¼‰
- `top_pathways` â†’ `top_pathway_names`ï¼ˆåªä¿ç•™åç§°ï¼‰

### 3. ç²¾ç®€`key_findings`æå–

**ä¿®å¤ä½ç½®**ï¼š`gibh_agent/agents/base_agent.py` ç¬¬1122-1175è¡Œ

**ä¿®å¤å†…å®¹**ï¼š
- âœ… åªæå–top 3æ ‡è®°ç‰©/ä»£è°¢ç‰©/é€šè·¯åç§°
- âœ… ä¸åŒ…å«å®Œæ•´çš„`top_up`ã€`top_down`åˆ—è¡¨ï¼Œåªä½¿ç”¨è®¡æ•°
- âœ… ç§»é™¤å†—ä½™çš„è¯¦ç»†æ•°æ®ï¼ˆlog2fcã€fdrã€VIPåˆ†æ•°ç­‰ï¼‰

### 4. ç²¾ç®€`execution_results_text`

**ä¿®å¤ä½ç½®**ï¼š`gibh_agent/agents/base_agent.py` ç¬¬1152-1174è¡Œ

**ä¿®å¤å†…å®¹**ï¼š
- âœ… ç§»é™¤CSVæ–‡ä»¶çš„å®Œæ•´è¡Œæ•°æ®ï¼ˆ`head_rows`ï¼‰
- âœ… åªä¿ç•™å…³é”®ç»Ÿè®¡ä¿¡æ¯ï¼ˆmean, median, std, min, maxï¼‰
- âœ… é™åˆ¶åˆ—åæ˜¾ç¤ºï¼ˆåªæ˜¾ç¤ºå‰5ä¸ªï¼‰
- âœ… é™åˆ¶å¤„ç†çš„CSVæ–‡ä»¶æ•°é‡ï¼ˆæœ€å¤š3ä¸ªï¼‰

### 5. æ·»åŠ Prompté•¿åº¦æ£€æŸ¥å’Œæˆªæ–­

**ä¿®å¤ä½ç½®**ï¼š`gibh_agent/agents/base_agent.py` ç¬¬1372-1450è¡Œ

**ä¿®å¤å†…å®¹**ï¼š
- âœ… åœ¨LLMè°ƒç”¨å‰æ£€æŸ¥promptæ€»é•¿åº¦
- âœ… è®°å½•å„éƒ¨åˆ†é•¿åº¦ï¼ˆSystem messageã€User messageã€summary_jsonã€key_findings_jsonã€execution_results_textï¼‰
- âœ… å¦‚æœæ€»é•¿åº¦è¶…è¿‡100kå­—ç¬¦ï¼Œè‡ªåŠ¨æˆªæ–­æˆ–ç®€åŒ–
- âœ… è®°å½•æˆªæ–­åçš„é•¿åº¦

## é¢„æœŸæ•ˆæœ

### JSONé•¿åº¦ä¼˜åŒ–

**ä¼˜åŒ–å‰**ï¼š
- `summary_json`: å¯èƒ½ > 10000å­—ç¬¦ï¼ˆåŒ…å«å®Œæ•´çš„step_dataï¼‰
- `key_findings_json`: å¯èƒ½ > 5000å­—ç¬¦ï¼ˆåŒ…å«å®Œæ•´çš„top_up/top_downåˆ—è¡¨ï¼‰
- `execution_results_text`: å¯èƒ½ > 10000å­—ç¬¦ï¼ˆåŒ…å«å®Œæ•´çš„CSVè¡Œæ•°æ®ï¼‰
- **æ€»è®¡**: > 25000å­—ç¬¦

**ä¼˜åŒ–å**ï¼š
- `summary_json`: < 2000å­—ç¬¦ï¼ˆåªåŒ…å«æ ¸å¿ƒæŒ‡æ ‡ï¼‰
- `key_findings_json`: < 1000å­—ç¬¦ï¼ˆåªåŒ…å«top 3åç§°ï¼‰
- `execution_results_text`: < 2000å­—ç¬¦ï¼ˆä¸åŒ…å«å®Œæ•´è¡Œæ•°æ®ï¼‰
- **æ€»è®¡**: < 5000å­—ç¬¦

### æ•°æ®ç²¾ç®€ç¤ºä¾‹

**ä¼˜åŒ–å‰**ï¼š
```json
{
  "steps": [{
    "name": "å·®å¼‚åˆ†æ",
    "status": "success",
    "significant_count": 150,
    "total_count": 1000,
    "method": "t-test",
    "case_group": "Treatment",
    "control_group": "Control",
    "top_up": ["Metabolite1", "Metabolite2", ...],  // å¯èƒ½åŒ…å«100+ä¸ª
    "top_down": ["MetaboliteA", "MetaboliteB", ...],  // å¯èƒ½åŒ…å«100+ä¸ª
    "top_markers": [
      {"name": "Met1", "log2fc": 2.345, "fdr": 0.001, ...},
      // ... å¯èƒ½åŒ…å«å®Œæ•´æ•°æ®
    ],
    "file_path": "/app/uploads/.../very/long/path/file.csv",  // å†—ä½™
    "preview": {...},  // å¤§å‹æ•°æ®
    "results": [...]  // å®Œæ•´ç»“æœåˆ—è¡¨ï¼Œå¯èƒ½åŒ…å«1000+æ¡
  }]
}
```

**ä¼˜åŒ–å**ï¼š
```json
{
  "steps": [{
    "name": "å·®å¼‚åˆ†æ",
    "status": "success",
    "significant_count": 150,
    "total_count": 1000,
    "top_marker_names": ["Met1", "Met2", "Met3"]  // åªä¿ç•™top 3åç§°
  }]
}
```

## å…³é”®æ”¹è¿›ç‚¹

1. **åªæå–æ ¸å¿ƒå­—æ®µ**ï¼šæ¯ä¸ªæ­¥éª¤åªä¿ç•™3-5ä¸ªå…³é”®æŒ‡æ ‡
2. **ç§»é™¤å¤§å‹æ•°æ®**ï¼šä¸åŒ…å«å®Œæ•´çš„resultsåˆ—è¡¨ã€previewæ•°æ®ã€æ–‡ä»¶è·¯å¾„ç­‰
3. **é™åˆ¶æ•°ç»„é•¿åº¦**ï¼šæ‰€æœ‰åˆ—è¡¨åªä¿ç•™top 3
4. **åªä¿ç•™åç§°**ï¼šæ ‡è®°ç‰©ã€ä»£è°¢ç‰©ã€é€šè·¯åªä¿ç•™åç§°ï¼Œä¸åŒ…å«è¯¦ç»†æ•°æ®
5. **ç§»é™¤å†—ä½™å­—æ®µ**ï¼šä¸åŒ…å«methodã€case_groupã€control_groupç­‰éæ ¸å¿ƒå­—æ®µ

## æµ‹è¯•å»ºè®®

1. **æ£€æŸ¥JSONé•¿åº¦**ï¼šæŸ¥çœ‹æ—¥å¿—ä¸­çš„`summary_jsoné•¿åº¦`ã€`key_findings_jsoné•¿åº¦`ç­‰
2. **éªŒè¯æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿ç²¾ç®€åçš„JSONä»åŒ…å«LLMéœ€è¦çš„æ ¸å¿ƒä¿¡æ¯
3. **æµ‹è¯•LLMè°ƒç”¨**ï¼šéªŒè¯LLMèƒ½å¦æˆåŠŸè°ƒç”¨å¹¶ç”ŸæˆæŠ¥å‘Š
4. **æ£€æŸ¥æŠ¥å‘Šè´¨é‡**ï¼šç¡®ä¿ç²¾ç®€æ•°æ®ä¸å½±å“æŠ¥å‘Šè´¨é‡

## æ—¥å¿—è¾“å‡º

ä¿®å¤åï¼Œåº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š
```
ğŸ“Š [AnalysisSummary] summary_jsoné•¿åº¦: 1500å­—ç¬¦
ğŸ“Š [AnalysisSummary] key_findings_jsoné•¿åº¦: 800å­—ç¬¦
ğŸ“Š [AnalysisSummary] execution_results_texté•¿åº¦: 1200å­—ç¬¦
ğŸ“Š [AnalysisSummary] Prompté•¿åº¦æ£€æŸ¥:
  - System message: 1200å­—ç¬¦
  - User message: 3500å­—ç¬¦
  - æ€»é•¿åº¦: 4700å­—ç¬¦
ğŸ“ [AnalysisSummary] å¼€å§‹LLMè°ƒç”¨ï¼Œmax_tokens=2500...
```

å¦‚æœçœ‹åˆ°"Promptè¿‡é•¿"è­¦å‘Šï¼Œè¯´æ˜ä»æœ‰ä¼˜åŒ–ç©ºé—´ï¼Œéœ€è¦è¿›ä¸€æ­¥ç²¾ç®€ã€‚
