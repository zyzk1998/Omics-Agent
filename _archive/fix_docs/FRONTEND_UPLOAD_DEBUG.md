# 前端文件上传问题排查指南

## 问题描述
用户选择了文件（如 matrix.mtx），但系统提示"没有检测到上传的文件"。

## 可能的原因

### 1. 文件未上传（最可能）
- **现象**: 文件显示在输入框中，但还在 `pendingFiles` 中
- **原因**: 用户选择了文件，但没有点击发送按钮
- **解决**: 确保用户点击发送按钮，文件才会被上传

### 2. 上传失败
- **现象**: 上传过程中出现错误
- **原因**: 
  - 网络问题
  - 文件大小超过限制
  - 文件类型不支持
  - 服务器错误
- **解决**: 查看浏览器控制台错误信息

### 3. 文件路径格式问题
- **现象**: 上传成功，但后端无法找到文件
- **原因**: 文件路径格式不正确
- **解决**: 检查后端返回的 `file_paths` 格式

### 4. 后端文件查找失败
- **现象**: 上传成功，但后端无法在服务器上找到文件
- **原因**: 
  - 文件路径不正确
  - 文件权限问题
  - 文件被删除
- **解决**: 检查服务器日志

## 排查步骤

### 步骤 1: 打开浏览器开发者工具
1. 按 `F12` 打开开发者工具
2. 切换到 `Console` 标签
3. 清空控制台日志

### 步骤 2: 重新尝试上传
1. 选择文件（如 matrix.mtx）
2. 输入问题（如"这是个什么文件?"）
3. 点击发送按钮
4. 观察控制台日志

### 步骤 3: 检查日志输出
应该看到以下日志：
- `📤 开始上传文件，待上传文件数: 1`
- `  - 添加文件到 FormData: matrix.mtx`
- `📡 发送上传请求到 /api/upload`
- `📥 收到上传响应，状态码: 200`
- `📦 上传响应数据: {...}`
- `📁 处理返回的文件路径，file_paths: [...]`
- `✅ 文件上传成功，返回文件路径: [...]`
- `📤 检测到待上传文件，开始上传...`
- `✅ 文件上传完成，新上传文件数: 1`
- `📋 当前 uploadedFiles 总数: 1`
- `💬 准备发送聊天请求，uploaded_files: [...]`
- `📤 发送聊天请求，payload: {...}`

### 步骤 4: 根据日志判断问题

#### 如果没有看到上传日志
- **问题**: 文件还在 `pendingFiles` 中，没有上传
- **原因**: 可能没有点击发送按钮，或者 `sendMessage` 没有被调用
- **解决**: 确保点击发送按钮

#### 如果看到上传失败日志
- **问题**: 上传请求失败
- **原因**: 网络问题、服务器错误、文件格式问题
- **解决**: 查看错误信息，检查服务器日志

#### 如果上传成功但后端找不到文件
- **问题**: 文件路径格式不正确
- **原因**: 后端返回的路径格式与前端期望不一致
- **解决**: 检查 `file_paths` 数组的内容

## 常见错误

### 错误 1: "文件上传失败: HTTP 413"
- **原因**: 文件大小超过限制（默认 100MB）
- **解决**: 检查文件大小，或修改 `MAX_FILE_SIZE` 配置

### 错误 2: "不允许的文件类型"
- **原因**: 文件扩展名不在允许列表中
- **解决**: 检查文件扩展名，确保在允许列表中

### 错误 3: "文件不存在"
- **原因**: 后端无法找到上传的文件
- **解决**: 检查服务器上的文件是否存在，检查文件路径

## 调试技巧

### 1. 检查 pendingFiles
在浏览器控制台输入：
```javascript
pendingFiles
```
应该看到文件对象数组

### 2. 检查 uploadedFiles
在浏览器控制台输入：
```javascript
uploadedFiles
```
应该看到已上传的文件信息数组

### 3. 手动触发上传
在浏览器控制台输入：
```javascript
uploadPendingFiles().then(files => console.log('上传的文件:', files))
```

### 4. 检查网络请求
1. 打开开发者工具的 `Network` 标签
2. 选择文件并发送
3. 查看 `/api/upload` 请求
4. 检查请求和响应内容

## 修复建议

如果问题持续存在，请：
1. 收集浏览器控制台日志
2. 收集服务器日志（`docker compose logs api-server`）
3. 检查网络请求和响应
4. 提供详细的错误信息

