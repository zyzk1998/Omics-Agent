# 单细胞转录组测序全流程（11步）交互提示词

本文档提供与 GIBH-AGENT-V2 RNA Agent 交互的完整提示词，用于执行单细胞转录组测序分析的全流程。

---

## 📋 流程概览

**11步完整流程：**
1. **Cell Ranger 计数**（从 FASTQ 开始，可选）
2. **数据检查**（强制步骤）
3. **质量控制 (QC)**
4. **数据标准化**
5. **筛选高变基因**
6. **数据缩放**
7. **主成分分析 (PCA)**
8. **构建邻接图**
9. **细胞聚类**
10. **UMAP 可视化**
11. **t-SNE 可视化**
12. **寻找 Marker 基因**

---

## 🚀 详细提示词

### 步骤 0: Cell Ranger 计数（从 FASTQ 开始）

**适用场景：** 你有原始 FASTQ 文件，需要先进行 Cell Ranger 计数

**提示词：**
```
我需要从 FASTQ 文件开始分析单细胞数据。

FASTQ 文件路径：/path/to/fastqs/
参考基因组路径：/path/to/refdata-gex-GRCh38-2024-A/
样本名称：sample_name

请帮我运行 Cell Ranger count，然后将输出转换为 Scanpy 格式。
```

**或者更详细的：**
```
我有单细胞测序的 FASTQ 文件，需要：
1. 运行 Cell Ranger count 进行计数
2. 将输出转换为 .h5ad 格式
3. 然后继续后续的分析流程

参数：
- FASTQ 目录：/data/fastqs/
- 参考基因组：/data/refdata-gex-GRCh38-2024-A/
- 样本名：pbmc_1k_v3
- CPU 核心数：8
- 内存：32GB
```

---

### 步骤 1: 数据检查（强制步骤）

**适用场景：** 你有 .h5ad 文件或 10x MTX 数据，需要先了解数据特征

**提示词：**
```
请检查这个数据文件：/path/to/data.h5ad

我需要了解：
- 数据规模（细胞数、基因数）
- 是否已标准化
- 已有的注释信息
- 数据质量指标
```

**或者更简洁：**
```
分析 /data/sample.h5ad
```

**注意：** Agent 会自动执行 `inspect_file`，然后根据检查结果推荐参数。

---

### 步骤 2: 质量控制 (QC)

**提示词（让 Agent 推荐参数）：**
```
检查完数据后，请推荐合适的 QC 参数，然后执行质量控制。
```

**提示词（指定参数）：**
```
执行质量控制，参数：
- 最小基因数：200
- 最大线粒体基因比例：5%
- 最小细胞数：3
```

**或者：**
```
对数据进行 QC 过滤，过滤掉：
- 基因数少于 200 的细胞
- 线粒体基因比例超过 5% 的细胞
- 表达少于 3 个细胞的基因
```

---

### 步骤 3: 数据标准化

**提示词：**
```
对数据进行标准化处理。
```

**或者指定方法：**
```
使用 scanpy 的 normalize_total 和 log1p 对数据进行标准化。
目标总和：10000
```

---

### 步骤 4: 筛选高变基因

**提示词：**
```
筛选高变基因（Highly Variable Genes）。
```

**或者指定参数：**
```
找出高变基因，参数：
- 最小均值：0.0125
- 最大均值：3
- 最小离散度：0.5
- 基因数量：2000
```

---

### 步骤 5: 数据缩放

**提示词：**
```
对高变基因进行缩放（scale）。
```

**或者：**
```
使用 scanpy 的 scale 函数对高变基因进行标准化，最大值为 10。
```

---

### 步骤 6: 主成分分析 (PCA)

**提示词：**
```
执行主成分分析（PCA）。
```

**或者指定参数：**
```
进行 PCA 降维，使用前 50 个主成分。
```

---

### 步骤 7: 构建邻接图

**提示词：**
```
构建细胞邻接图（neighbors graph）。
```

**或者指定参数：**
```
构建邻接图，参数：
- 最近邻数量：15
- 主成分数量：40
```

---

### 步骤 8: 细胞聚类

**提示词：**
```
对细胞进行聚类分析。
```

**或者指定参数：**
```
使用 Leiden 算法进行聚类，分辨率设为 0.5。
```

---

### 步骤 9: UMAP 可视化

**提示词：**
```
生成 UMAP 降维可视化图。
```

**或者：**
```
计算 UMAP 坐标并绘制可视化图，使用聚类结果进行着色。
```

---

### 步骤 10: t-SNE 可视化

**提示词：**
```
生成 t-SNE 降维可视化图。
```

**或者：**
```
计算 t-SNE 坐标并绘制可视化图，使用聚类结果进行着色。
```

---

### 步骤 11: 寻找 Marker 基因

**提示词：**
```
找出每个聚类的 Marker 基因。
```

**或者指定参数：**
```
为每个聚类寻找差异表达基因（Marker 基因），参数：
- 方法：wilcoxon
- 每个聚类返回前 5 个基因
- 最小 log2FC：0.25
```

---

## 🎯 完整流程一次性执行

如果你想一次性执行完整流程，可以使用：

**提示词 1（从 .h5ad 开始）：**
```
请对 /data/sample.h5ad 执行完整的单细胞分析流程：
1. 检查数据并推荐参数
2. 质量控制
3. 标准化
4. 筛选高变基因
5. 缩放
6. PCA
7. 构建邻接图
8. 聚类
9. UMAP 可视化
10. t-SNE 可视化
11. 寻找 Marker 基因

请先检查数据，然后推荐合适的参数，我确认后再执行。
```

**提示词 2（从 FASTQ 开始）：**
```
我需要从 FASTQ 文件开始执行完整的单细胞分析流程：

1. 运行 Cell Ranger count（FASTQ: /data/fastqs/, 参考基因组: /data/refdata/）
2. 转换为 .h5ad 格式
3. 检查数据并推荐参数
4. 执行后续 10 步分析流程

请逐步执行，每步完成后告诉我结果。
```

---

## 💡 提示词技巧

### 1. 让 Agent 自动推荐参数
```
检查数据后，请推荐合适的分析参数，我确认后再执行。
```

### 2. 指定特定参数
```
执行 QC，使用 min_genes=500, max_mt=5%
```

### 3. 跳过某些步骤
```
数据已经标准化过了，请跳过标准化步骤，直接从筛选高变基因开始。
```

### 4. 只执行部分流程
```
我只想执行到聚类这一步，不需要可视化和 Marker 基因分析。
```

### 5. 查看中间结果
```
执行完 PCA 后，请告诉我前 10 个主成分的贡献度。
```

---

## 📝 示例对话流程

**用户：**
```
分析 /data/pbmc_1k_v3_filtered.h5ad
```

**Agent（自动执行检查）：**
```
<think>
需要先检查数据文件，了解数据特征。
</think>

正在检查数据文件...

检查结果：
- 细胞数：1,221
- 基因数：38,606
- 数据状态：原始计数（未标准化）
- 已有注释：无

推荐参数：
- QC: min_genes=200, max_mt=5%
- 标准化：目标总和 10000
- 高变基因：2000 个
- 聚类分辨率：0.5

是否按此参数执行完整流程？
```

**用户：**
```
好的，按推荐参数执行完整流程。
```

**Agent：**
```
开始执行完整分析流程...
[执行中...]
✅ 分析完成！已生成所有结果和可视化图。
```

---

## 🔧 常见问题

### Q: 如何查看分析结果？
**A:** Agent 会自动保存结果到 `results/` 目录，包括：
- 处理后的 .h5ad 文件
- 可视化图片
- QC 报告

### Q: 如何修改参数？
**A:** 在 Agent 推荐参数后，直接说明你的修改：
```
使用你推荐的参数，但将聚类分辨率改为 0.8。
```

### Q: 如何只执行特定步骤？
**A:** 明确说明：
```
只执行 QC 和标准化，其他步骤跳过。
```

### Q: 数据已经部分处理过了怎么办？
**A:** 告诉 Agent：
```
这个数据已经做过 QC 和标准化了，请从筛选高变基因开始。
```

---

## 📚 相关文档

- `test_data/CELLRANGER_TUTORIAL.md` - Cell Ranger 使用教程
- `test_data/CELLRANGER_RESULTS.md` - Cell Ranger 运行结果示例
- `gibh_agent/tools/scanpy_tool.py` - Scanpy 工具实现

---

**最后更新：** 2024-12-19

