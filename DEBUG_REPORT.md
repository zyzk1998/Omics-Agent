# ğŸ” è°ƒè¯•è¯Šæ–­æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2025-01-28  
**è°ƒè¯•ä¾æ®**: `/home/ubuntu/GIBH-AGENT-V2/DEBUG_PROMPT_AI_REPORT_AND_TOOLS.md`

---

## ğŸ“Š é—®é¢˜1ï¼šAIä¸“å®¶åˆ†ææŠ¥å‘ŠLLMè°ƒç”¨å¤±è´¥

### ğŸ”´ æ ¹æœ¬åŸå› ï¼šè¯·æ±‚è¶…æ—¶ï¼ˆAPITimeoutErrorï¼‰

**è¯Šæ–­ç»“æœ**ï¼š
- âœ… APIå¯†é’¥å·²è®¾ç½®ä¸”æœ‰æ•ˆ
- âœ… åŸºæœ¬LLMè¿æ¥æ­£å¸¸ï¼ˆç®€å•è¯·æ±‚æˆåŠŸï¼‰
- âŒ **å¤æ‚è¯·æ±‚ï¼ˆmax_tokens=2500ï¼‰è¶…æ—¶**

**è¯¦ç»†é”™è¯¯ä¿¡æ¯**ï¼š
```
é”™è¯¯ç±»å‹: APITimeoutError
é”™è¯¯ä¿¡æ¯: Request timed out.
è¶…æ—¶è®¾ç½®: 60.0ç§’
è¯·æ±‚å‚æ•°: temperature=0.3, max_tokens=2500
```

**å¯èƒ½åŸå› **ï¼š
1. DeepSeek-R1æ¨¡å‹å“åº”è¾ƒæ…¢ï¼Œ60ç§’è¶…æ—¶æ—¶é—´ä¸å¤Ÿ
2. è¯·æ±‚å†…å®¹è¾ƒé•¿ï¼Œéœ€è¦æ›´é•¿çš„å¤„ç†æ—¶é—´
3. ç½‘ç»œå»¶è¿Ÿæˆ–APIæœåŠ¡å“åº”æ…¢

### âœ… è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šå¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆæ¨èï¼‰
**ä½ç½®**: `gibh_agent/core/llm_client.py` ç¬¬43è¡Œ

**ä¿®æ”¹**ï¼š
```python
# å½“å‰è®¾ç½®
timeout: float = 60.0

# å»ºè®®ä¿®æ”¹ä¸º
timeout: float = 180.0  # å¢åŠ åˆ°180ç§’ï¼ˆ3åˆ†é’Ÿï¼‰
```

**ç†ç”±**ï¼š
- DeepSeek-R1æ˜¯æ¨ç†æ¨¡å‹ï¼Œéœ€è¦æ›´é•¿çš„æ€è€ƒæ—¶é—´
- AIä¸“å®¶åˆ†ææŠ¥å‘Šç”Ÿæˆéœ€è¦å¤„ç†å¤§é‡æ•°æ®ï¼Œå“åº”æ—¶é—´è¾ƒé•¿

#### æ–¹æ¡ˆ2ï¼šä¼˜åŒ–è¯·æ±‚å†…å®¹
**ä½ç½®**: `gibh_agent/agents/base_agent.py` ç¬¬1200-1300è¡Œ

**ä¼˜åŒ–å»ºè®®**ï¼š
1. æˆªæ–­è¿‡é•¿çš„å…³é”®æŒ‡æ ‡JSONï¼ˆåªä¿ç•™æœ€é‡è¦çš„æŒ‡æ ‡ï¼‰
2. å‡å°‘system messageçš„é•¿åº¦
3. åˆ†é˜¶æ®µç”ŸæˆæŠ¥å‘Šï¼ˆå…ˆæ‘˜è¦ï¼Œåè¯¦ç»†ï¼‰

#### æ–¹æ¡ˆ3ï¼šæ·»åŠ é‡è¯•æœºåˆ¶
**ä½ç½®**: `gibh_agent/agents/base_agent.py` ç¬¬1307-1370è¡Œ

**å»ºè®®**ï¼š
- å¦‚æœè¶…æ—¶ï¼Œè‡ªåŠ¨é‡è¯•1-2æ¬¡
- æ¯æ¬¡é‡è¯•æ—¶å‡å°‘max_tokensï¼ˆå¦‚2500 -> 2000 -> 1500ï¼‰

---

## ğŸ“Š é—®é¢˜2ï¼šå·¥å…·æ‰§è¡Œå¤±è´¥

### ğŸ”´ æ ¹æœ¬åŸå› ï¼šåˆ†ç»„åˆ—æ£€æµ‹é€»è¾‘é—®é¢˜

**è¯Šæ–­ç»“æœ**ï¼š
- âœ… æ•°æ®æ–‡ä»¶è¯»å–æˆåŠŸ
- âŒ **æ‰€æœ‰åˆ—éƒ½è¢«è¯†åˆ«ä¸ºæ•°å€¼å‹**ï¼ˆåŒ…æ‹¬ `Diet` åˆ—ï¼‰
- âŒ **å·¥å…·æœŸæœ›çš„åˆ†ç»„åˆ—åæ˜¯ `'Sample'`ï¼Œä½†å®é™…æ•°æ®ä¸­æ˜¯ `'Diet'`**

**æ•°æ®æ–‡ä»¶åˆ†æ**ï¼š
```
æ–‡ä»¶: test_data/cow_diet.csv
å½¢çŠ¶: (10, 52)
åˆ—å: ['SampleID', 'Diet', 'Metabolite_1', ..., 'Metabolite_50']

å…³é”®å‘ç°:
- Dietåˆ—: int64 (æ•°å€¼å‹, å”¯ä¸€å€¼: 2) â† è¿™åº”è¯¥æ˜¯åˆ†ç»„åˆ—ï¼
- å·¥å…·æœŸæœ›: 'Sample' åˆ—
- å®é™…æ•°æ®: 'Diet' åˆ—
```

**é”™è¯¯ä¿¡æ¯**ï¼š
```
PLS-DA åˆ†æ: åˆ†ç»„åˆ— 'Sample' ä¸å­˜åœ¨äºæ•°æ®ä¸­
é€šè·¯å¯Œé›†åˆ†æ: åˆ†ç»„åˆ— 'Sample' ä¸å­˜åœ¨äºæ•°æ®ä¸­
```

### âœ… è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šæ”¹è¿›åˆ†ç»„åˆ—æ£€æµ‹é€»è¾‘ï¼ˆæ¨èï¼‰
**ä½ç½®**: `gibh_agent/core/executor.py` çš„ `_detect_group_column_from_file` å‡½æ•°

**ä¿®æ”¹å»ºè®®**ï¼š
1. **ä¼˜å…ˆæ£€æµ‹å¸¸è§åˆ†ç»„åˆ—å**ï¼š`['Sample', 'Group', 'Condition', 'Treatment', 'Class', 'Label', 'Diet']`
2. **æ™ºèƒ½æ£€æµ‹æ•°å€¼å‹åˆ†ç»„åˆ—**ï¼šå¦‚æœåˆ—çš„å”¯ä¸€å€¼åœ¨2-10ä¹‹é—´ï¼Œä¸”åˆ—ååŒ…å«åˆ†ç»„ç›¸å…³å…³é”®è¯ï¼Œä¹Ÿè§†ä¸ºåˆ†ç»„åˆ—
3. **æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º**ï¼šå¦‚æœæ‰¾ä¸åˆ°åˆ†ç»„åˆ—ï¼Œåˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„åˆ†ç»„åˆ—ä¾›ç”¨æˆ·é€‰æ‹©

**ä»£ç ç¤ºä¾‹**ï¼š
```python
def _detect_group_column_from_file(self, file_path: str) -> Optional[str]:
    # 1. ä¼˜å…ˆæ£€æµ‹å¸¸è§åˆ†ç»„åˆ—å
    common_group_names = ['Sample', 'Group', 'Condition', 'Treatment', 'Class', 'Label', 'Diet']
    for col in df.columns:
        if col in common_group_names:
            n_unique = df[col].nunique()
            if 2 <= n_unique <= 10:
                return col
    
    # 2. æ£€æµ‹æ•°å€¼å‹åˆ†ç»„åˆ—ï¼ˆå”¯ä¸€å€¼åœ¨2-10ä¹‹é—´ï¼Œä¸”åˆ—ååŒ…å«åˆ†ç»„å…³é”®è¯ï¼‰
    group_keywords = ['group', 'condition', 'treatment', 'class', 'label', 'diet', 'sample']
    for col in df.columns:
        if any(keyword in col.lower() for keyword in group_keywords):
            n_unique = df[col].nunique()
            if 2 <= n_unique <= 10:
                return col
    
    # 3. å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¿”å›Noneå¹¶è®°å½•æ‰€æœ‰å¯èƒ½çš„åˆ†ç»„åˆ—
    potential_cols = [(col, df[col].nunique()) for col in df.columns 
                      if 2 <= df[col].nunique() <= 10]
    if potential_cols:
        logger.warning(f"æœªæ‰¾åˆ°æ ‡å‡†åˆ†ç»„åˆ—ï¼Œä½†å‘ç°å¯èƒ½çš„åˆ†ç»„åˆ—: {potential_cols}")
        # è¿”å›ç¬¬ä¸€ä¸ªå¯èƒ½çš„åˆ†ç»„åˆ—
        return potential_cols[0][0]
    
    return None
```

#### æ–¹æ¡ˆ2ï¼šæ”¹è¿›é”™è¯¯æç¤º
**ä½ç½®**: `gibh_agent/tools/metabolomics/advanced.py` å’Œ `gibh_agent/tools/metabolomics/pathway_enrichment.py`

**ä¿®æ”¹å»ºè®®**ï¼š
- å¦‚æœæ‰¾ä¸åˆ°åˆ†ç»„åˆ—ï¼Œåˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„åˆ†ç»„åˆ—
- æä¾›æ•°æ®æ ¼å¼è¦æ±‚å’Œç¤ºä¾‹
- å»ºè®®ç”¨æˆ·å¦‚ä½•ä¿®å¤æ•°æ®æ ¼å¼

---

## ğŸ“Š é—®é¢˜3ï¼šå‰åç«¯é”™è¯¯ä¿¡æ¯ä¸ä¸€è‡´

### ğŸ”´ æ ¹æœ¬åŸå› ï¼šé”™è¯¯ä¿¡æ¯ä¼ é€’æœºåˆ¶ä¸å®Œå–„

**è¯Šæ–­ç»“æœ**ï¼š
- âœ… åç«¯æœ‰è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- âš ï¸ å‰ç«¯å¯èƒ½æ²¡æœ‰æ­£ç¡®æ¥æ”¶æˆ–æ˜¾ç¤ºæ‰€æœ‰é”™è¯¯ä¿¡æ¯

### âœ… è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šç»Ÿä¸€é”™è¯¯ä¿¡æ¯æ ¼å¼
**ä½ç½®**: `gibh_agent/core/executor.py` çš„ `execute_workflow` æ–¹æ³•

**ä¿®æ”¹å»ºè®®**ï¼š
- ç»Ÿä¸€é”™è¯¯ä¿¡æ¯æ ¼å¼ä¸ºJSONç»“æ„
- åŒ…å«ï¼šé”™è¯¯ç±»å‹ã€é”™è¯¯æ¶ˆæ¯ã€å¯èƒ½åŸå› ã€å»ºè®®

#### æ–¹æ¡ˆ2ï¼šå¢å¼ºå‰ç«¯é”™è¯¯æ˜¾ç¤º
**ä½ç½®**: `services/nginx/html/index.html` çš„ `renderExecutionSteps` å‡½æ•°

**ä¿®æ”¹å»ºè®®**ï¼š
- ç¡®ä¿æ‰€æœ‰é”™è¯¯ä¿¡æ¯éƒ½æ­£ç¡®æ˜¾ç¤º
- æä¾›æ›´å‹å¥½çš„é”™è¯¯æç¤º

---

## ğŸ¯ ä¼˜å…ˆçº§ä¿®å¤å»ºè®®

### ğŸ”¥ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰

1. **å¢åŠ LLMè¶…æ—¶æ—¶é—´**ï¼ˆé—®é¢˜1ï¼‰
   - å½±å“ï¼šAIä¸“å®¶åˆ†ææŠ¥å‘Šæ— æ³•ç”Ÿæˆ
   - ä¿®å¤æ—¶é—´ï¼š5åˆ†é’Ÿ
   - æ–‡ä»¶ï¼š`gibh_agent/core/llm_client.py`

2. **æ”¹è¿›åˆ†ç»„åˆ—æ£€æµ‹é€»è¾‘**ï¼ˆé—®é¢˜2ï¼‰
   - å½±å“ï¼šPLS-DAå’Œé€šè·¯å¯Œé›†åˆ†æå¤±è´¥
   - ä¿®å¤æ—¶é—´ï¼š30åˆ†é’Ÿ
   - æ–‡ä»¶ï¼š`gibh_agent/core/executor.py`

### âš ï¸ ä¸­ä¼˜å…ˆçº§ï¼ˆå°½å¿«ä¿®å¤ï¼‰

3. **ä¼˜åŒ–LLMè¯·æ±‚å†…å®¹**ï¼ˆé—®é¢˜1ï¼‰
   - å½±å“ï¼šå‡å°‘è¶…æ—¶é£é™©
   - ä¿®å¤æ—¶é—´ï¼š1å°æ—¶
   - æ–‡ä»¶ï¼š`gibh_agent/agents/base_agent.py`

4. **æ”¹è¿›é”™è¯¯æç¤º**ï¼ˆé—®é¢˜2ï¼‰
   - å½±å“ï¼šç”¨æˆ·ä½“éªŒ
   - ä¿®å¤æ—¶é—´ï¼š30åˆ†é’Ÿ
   - æ–‡ä»¶ï¼š`gibh_agent/tools/metabolomics/advanced.py`

### ğŸ“ ä½ä¼˜å…ˆçº§ï¼ˆåç»­ä¼˜åŒ–ï¼‰

5. **ç»Ÿä¸€é”™è¯¯ä¿¡æ¯æ ¼å¼**ï¼ˆé—®é¢˜3ï¼‰
   - å½±å“ï¼šè°ƒè¯•æ•ˆç‡
   - ä¿®å¤æ—¶é—´ï¼š1å°æ—¶
   - æ–‡ä»¶ï¼šå¤šä¸ªæ–‡ä»¶

---

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **å·²å®Œæˆ**ï¼šè¯Šæ–­é—®é¢˜æ ¹æœ¬åŸå› 
2. ğŸ”„ **è¿›è¡Œä¸­**ï¼šå®æ–½ä¿®å¤æ–¹æ¡ˆ
3. â³ **å¾…æ‰§è¡Œ**ï¼šæµ‹è¯•ä¿®å¤æ•ˆæœ
4. â³ **å¾…æ‰§è¡Œ**ï¼šéªŒè¯å‰åç«¯é”™è¯¯ä¿¡æ¯åŒæ­¥

---

## ğŸ”§ å¿«é€Ÿä¿®å¤å‘½ä»¤

### ä¿®å¤1ï¼šå¢åŠ LLMè¶…æ—¶æ—¶é—´
```bash
# ç¼–è¾‘æ–‡ä»¶
vim gibh_agent/core/llm_client.py

# ä¿®æ”¹ç¬¬43è¡Œ
# timeout: float = 60.0
# æ”¹ä¸º
# timeout: float = 180.0
```

### ä¿®å¤2ï¼šæ”¹è¿›åˆ†ç»„åˆ—æ£€æµ‹
```bash
# ç¼–è¾‘æ–‡ä»¶
vim gibh_agent/core/executor.py

# æ‰¾åˆ° _detect_group_column_from_file å‡½æ•°
# æŒ‰ç…§ä¸Šè¿°æ–¹æ¡ˆ1çš„ä»£ç ç¤ºä¾‹è¿›è¡Œä¿®æ”¹
```

---

**æŠ¥å‘Šç”Ÿæˆè€…**: AI Assistant  
**æœ€åæ›´æ–°**: 2025-01-28
