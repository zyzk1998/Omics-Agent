# å‰ç«¯ç”¨æˆ·ä½“éªŒä¼˜åŒ–æ€»ç»“

## ä¿®æ”¹çš„æ–‡ä»¶

1. **services/nginx/html/index.html** - èƒ–å‰ç«¯ï¼ˆå®Œæ•´åŠŸèƒ½ï¼‰
2. **services/nginx/html/lite.html** - ç˜¦å‰ç«¯ï¼ˆæ¼”ç¤ºç‰ˆæœ¬ï¼‰

---

## å®ç°çš„åŠŸèƒ½

### 1. Cell Ranger ç­‰å¾…æ°”æ³¡ âœ…

**åŠŸèƒ½æè¿°**: å½“æ£€æµ‹åˆ° Cell Ranger æ­¥éª¤æ­£åœ¨æ‰§è¡Œæ—¶ï¼Œæ˜¾ç¤ºå‹å¥½çš„ç­‰å¾…æ°”æ³¡æç¤ºã€‚

**å®ç°ä½ç½®**: `index.html`

**CSS æ ·å¼**:
- `.waiting-bubble`: å›ºå®šå®šä½çš„ç­‰å¾…æ°”æ³¡å®¹å™¨
- æ¸å˜èƒŒæ™¯ã€åŠ¨ç”»æ•ˆæœï¼ˆè„‰å†²å’Œæ—‹è½¬ï¼‰
- å“åº”å¼è®¾è®¡ï¼Œæœ€å¤§å®½åº¦ 400px

**JavaScript å‡½æ•°**:
- `showWaitingBubble(message)`: æ˜¾ç¤ºç­‰å¾…æ°”æ³¡
- `hideWaitingBubble()`: éšè—ç­‰å¾…æ°”æ³¡
- åœ¨ `handleServerEvent` çš„ `status` äº‹ä»¶ä¸­æ£€æµ‹ `show_waiting_bubble` æ ‡å¿—

**è§¦å‘æ¡ä»¶**:
- åç«¯å‘é€ `status` äº‹ä»¶ï¼Œä¸” `data.show_waiting_bubble === true`
- è‡ªåŠ¨åœ¨ `done` äº‹ä»¶æ—¶éšè—

**ç˜¦å‰ç«¯å®ç°** (`lite.html`):
- åœ¨æ§åˆ¶å°è¾“å‡ºç­‰å¾…æç¤º
- åœ¨å“åº”æ–‡æœ¬ä¸­æ·»åŠ æç¤ºä¿¡æ¯

---

### 2. æµ‹è¯•æ•°æ®è¯¢é—®å¯¹è¯æ¡† âœ…

**åŠŸèƒ½æè¿°**: å½“æ£€æµ‹åˆ°ç”¨æˆ·æƒ³è¦è¿›è¡Œ RNA åˆ†æå…¨æµç¨‹ä½†æœªä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œæ˜¾ç¤ºå¯¹è¯æ¡†è¯¢é—®æ˜¯å¦ä½¿ç”¨æµ‹è¯•æ•°æ®ã€‚

**å®ç°ä½ç½®**: `index.html`

**CSS æ ·å¼**:
- `.test-data-modal`: æ¨¡æ€å¯¹è¯æ¡†é®ç½©å±‚
- `.test-data-dialog`: å¯¹è¯æ¡†å†…å®¹åŒºåŸŸ
- `.test-data-info`: æµ‹è¯•æ•°æ®ä¿¡æ¯å±•ç¤ºåŒºåŸŸ

**JavaScript å‡½æ•°**:
- `handleTestDataQuestion(questionData)`: å¤„ç†æµ‹è¯•æ•°æ®è¯¢é—®
- `window.confirmTestData(testDataPath, testDataName)`: ç¡®è®¤ä½¿ç”¨æµ‹è¯•æ•°æ®ï¼ˆå…¨å±€å‡½æ•°ï¼‰

**è§¦å‘æ¡ä»¶**:
- åç«¯å‘é€ `workflow` äº‹ä»¶ï¼Œä¸” `data.test_data_question` å­˜åœ¨
- åœ¨ `handleServerEvent` çš„ `workflow` äº‹ä»¶åˆ†æ”¯ä¸­å¤„ç†

**å¯¹è¯æ¡†å†…å®¹**:
- é—®é¢˜æ ‡é¢˜
- è¯´æ˜æ¶ˆæ¯
- æµ‹è¯•æ•°æ®ä¿¡æ¯ï¼ˆåç§°ã€æè¿°ã€å¤§å°ï¼‰
- ç¡®è®¤/å–æ¶ˆæŒ‰é’®

**ç¡®è®¤åçš„è¡Œä¸º**:
- ä½¿ç”¨æµ‹è¯•æ•°æ®è·¯å¾„é‡æ–°è°ƒç”¨ `sendMessage`
- è‡ªåŠ¨å¡«å…… `uploaded_files` å‚æ•°

**ç˜¦å‰ç«¯å®ç°** (`lite.html`):
- ä½¿ç”¨ `confirm()` å¯¹è¯æ¡†è¯¢é—®ç”¨æˆ·
- ç¡®è®¤åæ›´æ–° `uploadedFiles` å¹¶é‡æ–°å‘é€è¯·æ±‚

---

### 3. æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯æ˜¾ç¤º âœ…

**åŠŸèƒ½æè¿°**: åœ¨æ‰§è¡Œç»“æœå¡ç‰‡ä¸­æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯ï¼Œè€Œä¸æ˜¯é¢å‘ç¨‹åºå‘˜çš„æ—¥å¿—ã€‚

**å®ç°ä½ç½®**: `index.html` - `renderExecutionSteps` å‡½æ•°

**æ˜¾ç¤ºå†…å®¹**:
- **ç”¨æˆ·å‹å¥½æ¶ˆæ¯** (`user_message`): ç®€åŒ–çš„é”™è¯¯æè¿°
- **é”™è¯¯ç±»åˆ«** (`error_category`): é”™è¯¯ç±»å‹ï¼ˆæ•°æ®é—®é¢˜ã€é…ç½®é—®é¢˜ã€ç½‘ç»œé—®é¢˜ç­‰ï¼‰
- **ä¼˜åŒ–å»ºè®®** (`suggestion`): å¦‚ä½•è§£å†³æˆ–ä¼˜åŒ–
- **å¯è·³è¿‡æ ‡å¿—** (`can_skip`): æ˜¯å¦å¯è·³è¿‡æ­¤æ­¥éª¤
- **æŠ€æœ¯ç»†èŠ‚** (`technical_details`): å¯æŠ˜å çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆä¾›è°ƒè¯•ï¼‰

**HTML ç»“æ„**:
```html
<div class="alert alert-danger">
    <strong>âŒ æ‰§è¡Œå¤±è´¥ï¼š</strong>
    <div>
        <div><strong>é—®é¢˜ï¼š</strong>{user_message}</div>
        <div><strong>é”™è¯¯ç±»å‹ï¼š</strong>{error_category}</div>
        <div><strong>ğŸ’¡ å»ºè®®ï¼š</strong>{suggestion}</div>
        <div><strong>âœ“ å¯è·³è¿‡ï¼š</strong>æ­¤æ­¥éª¤å¯ä»¥è·³è¿‡ï¼Œä¸å½±å“å…¶ä»–åˆ†æ</div>
        <details>
            <summary>æŸ¥çœ‹æŠ€æœ¯ç»†èŠ‚</summary>
            <pre>{technical_details}</pre>
        </details>
    </div>
</div>
```

**é”™è¯¯ç±»åˆ«**:
- `data_issue`: æ•°æ®æ–‡ä»¶é—®é¢˜ï¼ˆä¸èƒ½è·³è¿‡ï¼‰
- `config_issue`: é…ç½®/ä¾èµ–é—®é¢˜ï¼ˆéƒ¨åˆ†å¯è·³è¿‡ï¼‰
- `network_issue`: ç½‘ç»œ/ä¸‹è½½é—®é¢˜ï¼ˆå¯è·³è¿‡ï¼‰
- `resource_issue`: èµ„æºä¸è¶³ï¼ˆå¯è·³è¿‡ï¼‰
- `data_quality`: æ•°æ®è´¨é‡é—®é¢˜ï¼ˆé€šå¸¸å¯å¿½ç•¥ï¼‰
- `internal_error`: å†…éƒ¨é”™è¯¯ï¼ˆå¯è·³è¿‡ï¼‰
- `unknown_error`: æœªçŸ¥é”™è¯¯ï¼ˆå¯è·³è¿‡ï¼‰

---

## ä»£ç ä¿®æ”¹è¯¦æƒ…

### index.html ä¿®æ”¹

1. **CSS æ ·å¼** (çº¦ç¬¬ 417-520 è¡Œ):
   - æ·»åŠ  `.waiting-bubble` ç›¸å…³æ ·å¼
   - æ·»åŠ  `.test-data-modal` ç›¸å…³æ ·å¼

2. **SSE äº‹ä»¶å¤„ç†** (çº¦ç¬¬ 1448-1541 è¡Œ):
   - `status` äº‹ä»¶: æ£€æµ‹ `show_waiting_bubble` å¹¶æ˜¾ç¤ºæ°”æ³¡
   - `workflow` äº‹ä»¶: æ£€æµ‹ `test_data_question` å¹¶æ˜¾ç¤ºå¯¹è¯æ¡†
   - `done` äº‹ä»¶: éšè—ç­‰å¾…æ°”æ³¡

3. **é”™è¯¯æ˜¾ç¤º** (çº¦ç¬¬ 2205-2220 è¡Œ):
   - åœ¨ `renderExecutionSteps` ä¸­å¢å¼ºé”™è¯¯ä¿¡æ¯æ˜¾ç¤º
   - æ˜¾ç¤ºæ ¼å¼åŒ–çš„ç”¨æˆ·å‹å¥½é”™è¯¯ä¿¡æ¯

4. **è¾…åŠ©å‡½æ•°** (çº¦ç¬¬ 2770-2850 è¡Œ):
   - `showWaitingBubble(message)`: æ˜¾ç¤ºç­‰å¾…æ°”æ³¡
   - `hideWaitingBubble()`: éšè—ç­‰å¾…æ°”æ³¡
   - `handleTestDataQuestion(questionData)`: å¤„ç†æµ‹è¯•æ•°æ®è¯¢é—®
   - `window.confirmTestData()`: ç¡®è®¤ä½¿ç”¨æµ‹è¯•æ•°æ®ï¼ˆå…¨å±€å‡½æ•°ï¼‰

### lite.html ä¿®æ”¹

1. **SSE äº‹ä»¶å¤„ç†** (çº¦ç¬¬ 524-537 è¡Œ):
   - æ£€æµ‹ `show_waiting_bubble` å¹¶åœ¨æ§åˆ¶å°/å“åº”ä¸­æ˜¾ç¤ºæç¤º
   - æ£€æµ‹ `test_data_question` å¹¶ä½¿ç”¨ `confirm()` è¯¢é—®ç”¨æˆ·

---

## å‰åç«¯æ•°æ®æµ

### 1. Cell Ranger ç­‰å¾…æ°”æ³¡

```
åç«¯ (orchestrator.py)
  â†“ æ£€æµ‹åˆ° cellranger æ­¥éª¤
  â†“ å‘é€ SSE äº‹ä»¶
event: status
data: {
  "content": "â³ Cell Ranger æ­£åœ¨åå°è¿è¡Œ...",
  "state": "async_job_started",
  "show_waiting_bubble": true,
  "waiting_message": "Cell Ranger æ­£åœ¨å¤„ç†æ‚¨çš„æ•°æ®ï¼Œè¯·ç¨å€™..."
}
  â†“
å‰ç«¯ (index.html)
  â†“ handleServerEvent('status', data)
  â†“ showWaitingBubble(data.waiting_message)
  â†“ æ˜¾ç¤ºç­‰å¾…æ°”æ³¡
```

### 2. æµ‹è¯•æ•°æ®è¯¢é—®

```
åç«¯ (orchestrator.py)
  â†“ æ£€æµ‹åˆ° RNA å…¨æµç¨‹æ„å›¾ä½†æ— æ–‡ä»¶
  â†“ å‘é€ SSE äº‹ä»¶
event: workflow
data: {
  "workflow_config": null,
  "template_mode": true,
  "test_data_question": {
    "type": "test_data_question",
    "question": "æ˜¯å¦ä½¿ç”¨æµ‹è¯•æ•°æ®è¿›è¡Œå…¨æµç¨‹åˆ†æï¼Ÿ",
    "message": "æ£€æµ‹åˆ°æ‚¨æƒ³è¦è¿›è¡Œ RNA åˆ†æå…¨æµç¨‹...",
    "test_data_path": "/app/test_data/pbmc_1k_v3_fastqs",
    "test_data_info": {...}
  }
}
  â†“
å‰ç«¯ (index.html)
  â†“ handleServerEvent('workflow', data)
  â†“ handleTestDataQuestion(data.test_data_question)
  â†“ æ˜¾ç¤ºå¯¹è¯æ¡†
  â†“ ç”¨æˆ·ç¡®è®¤
  â†“ confirmTestData()
  â†“ ä½¿ç”¨æµ‹è¯•æ•°æ®é‡æ–°å‘é€è¯·æ±‚
```

### 3. æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯

```
åç«¯ (executor.py)
  â†“ æ­¥éª¤æ‰§è¡Œå¤±è´¥
  â†“ ErrorFormatter.format_error()
  â†“ è¿”å›æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯
  â†“ åŒ…å«åœ¨ step_detail ä¸­
  â†“
å‰ç«¯ (index.html)
  â†“ renderExecutionSteps(stepsDetails)
  â†“ æ£€æµ‹ step.status === 'error'
  â†“ æ˜¾ç¤ºæ ¼å¼åŒ–çš„é”™è¯¯ä¿¡æ¯
  â†“ åŒ…å« user_message, suggestion, can_skip ç­‰
```

---

## æµ‹è¯•å»ºè®®

### 1. Cell Ranger ç­‰å¾…æ°”æ³¡æµ‹è¯•

1. è§¦å‘åŒ…å« `rna_cellranger_count` æ­¥éª¤çš„å·¥ä½œæµ
2. éªŒè¯ç­‰å¾…æ°”æ³¡æ­£ç¡®æ˜¾ç¤º
3. éªŒè¯æ°”æ³¡æ¶ˆæ¯å†…å®¹æ­£ç¡®
4. éªŒè¯ `done` äº‹ä»¶æ—¶æ°”æ³¡è‡ªåŠ¨éšè—

### 2. æµ‹è¯•æ•°æ®è¯¢é—®æµ‹è¯•

1. å‘é€ RNA åˆ†æå…¨æµç¨‹æŸ¥è¯¢ï¼Œä½†ä¸ä¸Šä¼ æ–‡ä»¶
2. éªŒè¯æ”¶åˆ°æµ‹è¯•æ•°æ®è¯¢é—®å¯¹è¯æ¡†
3. éªŒè¯å¯¹è¯æ¡†å†…å®¹æ­£ç¡®ï¼ˆé—®é¢˜ã€æ¶ˆæ¯ã€æµ‹è¯•æ•°æ®ä¿¡æ¯ï¼‰
4. ç‚¹å‡»"ç¡®è®¤ä½¿ç”¨"ï¼ŒéªŒè¯ä½¿ç”¨æµ‹è¯•æ•°æ®é‡æ–°å‘é€è¯·æ±‚
5. ç‚¹å‡»"å–æ¶ˆ"ï¼ŒéªŒè¯å¯¹è¯æ¡†å…³é—­ä¸”ä¸å‘é€è¯·æ±‚

### 3. é”™è¯¯ä¿¡æ¯æ ¼å¼åŒ–æµ‹è¯•

1. è§¦å‘ä¼šå¤±è´¥çš„æ­¥éª¤ï¼ˆå¦‚ç¼ºå°‘ä¾èµ–çš„æ­¥éª¤ï¼‰
2. éªŒè¯é”™è¯¯ä¿¡æ¯æ˜¯ç”¨æˆ·å‹å¥½çš„ï¼ˆä¸æ˜¯æŠ€æœ¯æ—¥å¿—ï¼‰
3. éªŒè¯é”™è¯¯ç±»åˆ«ã€å»ºè®®ã€å¯è·³è¿‡æ ‡å¿—æ­£ç¡®æ˜¾ç¤º
4. éªŒè¯æŠ€æœ¯ç»†èŠ‚å¯ä»¥å±•å¼€/æŠ˜å 
5. éªŒè¯å¯è·³è¿‡çš„æ­¥éª¤æœ‰æ˜ç¡®çš„æç¤º

---

## å…¼å®¹æ€§è¯´æ˜

- **èƒ–å‰ç«¯** (`index.html`): å®Œæ•´åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç¾è§‚çš„ UI ç»„ä»¶
- **ç˜¦å‰ç«¯** (`lite.html`): ç®€åŒ–åŠŸèƒ½ï¼Œä½¿ç”¨æµè§ˆå™¨åŸç”Ÿå¯¹è¯æ¡†

---

**ä¿®å¤æ—¥æœŸ**: 2025-01-28  
**ä¿®å¤äººå‘˜**: AI Assistant  
**çŠ¶æ€**: âœ… å·²å®Œæˆ
